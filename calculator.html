<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Montreal Mortgage Qualification Calculator</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary-color: #E67E22; /* Darker orange */
      --primary-light: #F39C12; /* Orange */
      --primary-dark: #D35400; /* Deep orange */
      --accent-color: #2980B9; /* Deep blue */
      --accent-light: #3498DB; /* Blue */
      --accent-dark: #2C3E50; /* Navy */
      --background-color: #F8F9FA; /* Light gray background */
      --text-color: #2C3E50; /* Dark blue-gray text */
      --card-bg: #FFFFFF;
      --card-bg-rgb: 255, 255, 255;
      --border-color: #BDC3C7;
      --shadow-color: rgba(0, 0, 0, 0.15);
      --shadow-color-rgb: 0, 0, 0;
      --accent-color-rgb: 41, 128, 185;
      --success-color: #4caf50;
      --warning-color: #ff9800;
      --danger-color: #f44336;
      --info-color: #2196F3;
      --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--primary-light));
      --gradient-accent: linear-gradient(135deg, var(--accent-color), var(--accent-light));
      --gradient-card: linear-gradient(170deg, var(--card-bg), rgba(255,255,255,0.03));
    }
    
    [data-theme="dark"] {
      --primary-color: #FFD700; /* Gold */
      --primary-light: #FFDF33; /* Lighter gold */
      --primary-dark: #CCAC00; /* Darker gold */
      --accent-color: #87CEEB; /* Baby blue */
      --accent-light: #A7DEF5; /* Lighter baby blue */
      --accent-dark: #5FAAC2; /* Darker baby blue */
      --background-color: #000000; /* Black */
      --text-color: #F0F0F5; /* Off-white */
      --card-bg: #1A1A1A; /* Dark gray */
      --card-bg-rgb: 26, 26, 26;
      --border-color: #333333;
      --shadow-color: rgba(0, 0, 0, 0.3);
      --shadow-color-rgb: 0, 0, 0;
      --accent-color-rgb: 135, 206, 235;
      --gradient-card: linear-gradient(170deg, var(--card-bg), rgba(0,0,0,0.2));
    }

    [data-theme="sunrise"] {
      --primary-color: #FF7B54;
      --primary-light: #FFB26B;
      --accent-color: #FFD56F;
      --accent-light: #FFE6BC;
      --background-color: #FFF9F0;
    }

    [data-theme="sunset"] {
      --primary-color: #FF6B6B;
      --primary-light: #FF8E8E;
      --accent-color: #845EC2;
      --accent-light: #B39CD0;
      --background-color: #2C2C2C;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      transition: background-color 0.3s, color 0.3s, border-color 0.3s;
    }
    
    body {
      font-family: 'Montserrat', sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      line-height: 1.6;
      min-height: 100vh;
      padding: 0 20px;
      position: relative;
      overflow-x: hidden;
      background-image: 
        radial-gradient(circle at 10% 20%, var(--primary-color, #FFD700), transparent 250px),
        radial-gradient(circle at 90% 80%, var(--accent-color, #87CEEB), transparent 250px);
      background-attachment: fixed;
    }
    
    h1, h2, h3, h4, h5 {
      font-family: 'Playfair Display', serif;
      color: var(--text-color);
      margin-bottom: 1rem;
    }
    
    h1 {
      font-size: 2.5rem;
      text-align: center;
      margin: 2rem 0;
      position: relative;
      display: inline-block;
      color: var(--primary-color);
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    
    h1::after {
      content: "";
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 100px;
      height: 3px;
      background: linear-gradient(90deg, var(--primary-color), var(--accent-color), var(--primary-color));
    }
    
    .header-container {
      text-align: center;
      position: relative;
      margin-bottom: 2rem;
    }

    .boc-meeting {
      position: relative;
      margin: 15px auto 0;
      width: 80%;
      left: 0;
      right: 0;
      max-width: 600px;
      background: rgba(var(--card-bg-rgb, 255, 255, 255), 0.7);
      padding: 8px 15px;
      border-radius: 6px;
      border: 1px solid rgba(var(--accent-color-rgb, 41, 128, 185), 0.6);
      box-shadow: 0 1px 4px rgba(var(--shadow-color-rgb, 0, 0, 0), 0.1);
      backdrop-filter: blur(3px);
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-size: 0.9rem;
      text-overflow: ellipsis;
      white-space: nowrap;
      transition: all 0.3s ease;
      text-align: center;
    }
    
    @media (max-width: 768px) {
      .boc-meeting {
        font-size: 0.8rem;
        padding: 5px 10px;
        margin-top: 10px;
      }
    }

    @media (max-width: 480px) {
      .boc-meeting {
        font-size: 0.75rem;
        padding: 4px 8px;
        margin-top: 5px;
        max-width: 95%;
      }
      
      .header-container {
        margin-top: 15px; /* Reduce top margin */
      }
    }

    .boc-meeting-icon {
      color: var(--accent-color);
      flex-shrink: 0;
    }

    .boc-meeting-date {
      font-weight: 500;
      color: var(--primary-color);
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .boc-meeting-details {
      position: absolute;
      top: 100%;
      right: 0;
      background: var(--card-bg);
      padding: 15px;
      border-radius: 8px;
      border: 1px solid var(--accent-color);
      box-shadow: 0 4px 12px var(--shadow-color);
      width: 300px;
      max-width: 90vw;
      display: none;
      z-index: 101;
    }

    .boc-meeting:hover .boc-meeting-details {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    .consensus-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 0.85rem;
    }

    .consensus-label {
      color: var(--text-color);
    }

    .consensus-value {
      font-weight: 600;
      color: var(--accent-color);
    }

    .boc-sources {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border-color);
      font-size: 0.8rem;
    }

    .boc-source-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
      color: var(--text-color);
    }

    .boc-source-icon {
      color: var(--accent-color);
      font-size: 1rem;
    }

    .boc-source-link {
      color: var(--accent-color);
      text-decoration: none;
      transition: color 0.3s ease;
    }

    .boc-source-link:hover {
      color: var(--primary-color);
    }
    
    .theme-toggle {
      position: fixed;
      right: 20px;
      top: 20px;
      background: var(--card-bg);
      border: 1px solid var(--accent-color);
      padding: 0.5rem;
      border-radius: 50px;
      cursor: pointer;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 10px var(--shadow-color);
      z-index: 100;
    }
    
    .theme-toggle svg {
      width: 24px;
      height: 24px;
      fill: var(--accent-color);
    }
    
    .language-selector {
      position: fixed;
      left: 10px;
      top: 20px;
      background: var(--card-bg);
      border: 1px solid var(--accent-color);
      padding: 0.3rem 0.5rem;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 2px 5px var(--shadow-color);
      z-index: 100;
      display: flex;
      align-items: center;
      font-size: 0.85rem;
    }
    
    @media (max-width: 480px) {
      .language-selector {
        top: 800px; /* Position extremely low on the screen to avoid any possible overlap */
        left: 10px;
        z-index: 90;
        position: absolute; /* Change to absolute positioning instead of fixed */
      }
      
      /* Increase header container top margin to accommodate only the banner */
      .header-container {
        margin-top: 120px; /* Reduced since language selector is now separate */
      }
      
      /* Ensure BOC banner has enough vertical space */
      .boc-meeting {
        padding-bottom: 12px; /* Add more padding at the bottom */
      }
    }
    
    .language-selector select {
      background: transparent;
      border: none;
      color: var(--text-color);
      font-family: 'Montserrat', sans-serif;
      cursor: pointer;
      padding-right: 0.5rem;
      font-weight: 500;
      font-size: 0.85rem;
    }
    
    .language-selector select:focus {
      outline: none;
    }

    .blog-button {
      position: fixed;
      left: 10px;
      top: 120px;
      background: var(--card-bg);
      border: 1px solid var(--accent-color);
      padding: 0.3rem 0.8rem;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 2px 5px var(--shadow-color);
      z-index: 100;
      display: flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      color: var(--text-color);
      font-size: 0.85rem;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .blog-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px var(--shadow-color);
    }

    .blog-icon {
      font-size: 1.1rem;
    }

    @media (max-width: 480px) {
      .blog-button {
        display: none;
      }
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
      position: relative;
    }
    
    .form-container, .results-container {
      display: none;
    }
    
    .form-container.active, .results-container.active {
      display: block;
      animation: fadeIn 0.5s ease forwards;
    }
    
    .card {
      background: var(--gradient-card);
      border-radius: 12px;
      box-shadow: 0 8px 24px var(--shadow-color);
      padding: 2rem;
      position: relative;
      overflow: hidden;
      border: none;
      margin-bottom: 2rem;
    }
    
    .card::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: var(--primary-color);
    }
    
    .step-indicator {
      display: flex;
      justify-content: space-between;
      margin-bottom: 3rem;
      position: relative;
      touch-action: manipulation;
    }
    
    .step-indicator::before {
      content: "";
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 2px;
      background-color: var(--border-color);
      z-index: 1;
    }
    
    .step {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background-color: var(--card-bg);
      border: 2px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.2rem;
      z-index: 2;
      position: relative;
      cursor: pointer;
      transition: box-shadow 0.3s ease, transform 0.3s ease;
      min-width: 34px; /* Ensure minimum touch target size */
      min-height: 34px;
      -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
      margin-bottom: 40px; /* Add space below the step number */
    }
    
    .step.active {
      background: var(--gradient-primary);
      border-color: var(--primary-color);
      color: black; /* Changed from white to black for better visibility in dark mode */
      box-shadow: 0 0 15px var(--primary-color);
      transform: scale(1.1);
    }
    
    .step.completed {
      background-color: var(--accent-color);
      border-color: var(--accent-color);
      color: black;
    }

    .step:hover {
      box-shadow: 0 0 15px var(--primary-light);
    }
    
    .step:active {
      transform: scale(0.95);
      transition: transform 0.1s;
    }
    
    .step-content {
      display: none;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    
    .step-content.active {
      display: block;
      opacity: 1;
      transform: translateY(0);
      animation: slideIn 0.3s ease-out;
    }
    
    .form-group {
      margin-bottom: 1.5rem;
      position: relative;
    }

    .form-group:focus-within label {
      color: var(--primary-color);
      transform: translateY(-2px);
      transition: all 0.2s ease;
    }
    
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--primary-color);
    }
    
    input[type="number"], input[type="text"], input[type="email"], select {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 1rem;
      background-color: var(--card-bg);
      color: var(--text-color);
      transition: border-color 0.3s, box-shadow 0.3s;
      font-family: 'Montserrat', sans-serif;
    }
    
    input[type="range"] {
      width: 100%;
      margin-top: 10px;
      accent-color: var(--accent-color);
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.15);
    }
    
    .input-group {
      position: relative;
    }
    
    .input-group input[type="number"] {
      padding-left: 40px;
    }
    
    .input-prefix {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--accent-color);
      font-weight: bold;
    }
    
    .button-group {
      display: flex;
      justify-content: space-between;
      margin-top: 2rem;
      gap: 0.75rem;
    }
    
    button {
      background: var(--primary-color);
      color: black; /* Changed from white to black for better visibility in dark mode */
      border: none;
      padding: 14px 28px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'Playfair Display', serif;
      box-shadow: 0 4px 12px rgba(255, 215, 0, 0.2);
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(255, 215, 0, 0.3);
      background: var(--primary-light);
    }

    button:active {
      transform: scale(0.98);
    }
    
    button.secondary {
      background: transparent;
      border: 2px solid var(--primary-color);
      color: var(--primary-color);
      box-shadow: none;
    }
    
    button.secondary:hover {
      background-color: rgba(255, 215, 0, 0.1);
    }
    
    .optional-notice {
      color: var(--accent-color);
      font-size: 0.9rem;
      font-style: italic;
      margin-bottom: 1rem;
    }
    
    .result-card {
      background: var(--gradient-card);
      border-radius: 15px;
      padding: 2rem;
      margin-bottom: 2rem;
      border: 1px solid var(--border-color);
      position: relative;
      overflow: hidden;
      box-shadow: 0 10px 30px var(--shadow-color);
      animation: scaleIn 0.4s ease-out;
    }
    
    .result-card::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 5px;
      height: 100%;
      background: linear-gradient(to bottom, var(--primary-color), var(--accent-color));
    }
    
    .result-header {
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
    }
    
    .result-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
    }
    
    .result-item:last-child {
      border-bottom: none;
    }

    .result-item.payment-summary {
      display: block;
      margin: 2rem 0;
    }
    
    .payment-details-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1.5rem;
      margin-top: 1.5rem;
    }
    
    .payment-option-card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 1.5rem;
      text-align: center;
      box-shadow: 0 4px 12px var(--shadow-color);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .payment-option-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px var(--shadow-color);
    }
    
    .payment-option-title {
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
    }
    
    .payment-option-amount {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--accent-color);
      margin: 0.5rem 0;
    }
    
    .payment-option-frequency {
      font-size: 0.9rem;
      color: var(--text-color);
      opacity: 0.8;
    }
    
    .value {
      font-weight: 600;
      font-size: 1.1rem;
      color: var(--accent-color);
    }
    
    .highlight {
      color: var(--accent-color);
      font-weight: 700;
    }
    
    .chart-container {
      height: 300px;
      margin: 2rem 0;
    }
    
    .qualification-status {
      padding: 1rem;
      border-radius: 8px;
      font-weight: 600;
      margin: 2rem 0;
      text-align: center;
    }
    
    .qualification-status.approved {
      background: var(--gradient-accent);
      color: var(--success-color);
      border: 1px solid var(--success-color);
    }
    
    .qualification-status.warning {
      background-color: rgba(255, 215, 0, 0.15);
      color: var(--warning-color);
      border: 1px solid var(--warning-color);
    }
    
    .qualification-status.denied {
      background-color: rgba(255, 77, 77, 0.15);
      color: var(--danger-color);
      border: 1px solid var(--danger-color);
    }
    
    .ratio-text {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 1rem 0;
    }
    
    .max-amount {
      font-size: 1.5rem;
      text-align: center;
      padding: 1.5rem;
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.05), rgba(135, 206, 235, 0.05));
      border-radius: 8px;
      margin: 2rem 0;
      border: 1px solid var(--accent-color);
    }
    
    .max-amount .amount {
      color: var(--accent-color);
      font-size: 2.5rem;
      font-weight: 700;
      display: block;
      margin: 0.5rem 0;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    
    /* Modal for details */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(5px);
    }
    
    .modal.active {
      display: flex;
      animation: fadeIn 0.3s ease;
    }
    
    .modal-content {
      background-color: var(--card-bg);
      border-radius: 15px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      padding: 2rem;
      position: relative;
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
      border: 1px solid var(--accent-color);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
    }
    
    .close-modal {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--accent-color);
    }
    
    .detail-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 0.5rem;
    }
    
    .detail-label {
      font-weight: 500;
      color: var(--primary-color);
    }
    
    .detail-section {
      margin-bottom: 2rem;
    }
    
    /* Spinner */
    .spinner {
      border: 4px solid rgba(135, 206, 235, 0.3);
      border-top: 4px solid var(--accent-color);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    
    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    
    /* Loading state */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .loading-message {
      background-color: var(--card-bg);
      border-radius: 8px;
      padding: 2rem;
      text-align: center;
      box-shadow: 0 10px 30px var(--shadow-color);
    }
    
    /* Print styles */
    @media print {
      body {
        background: none;
        color: #000;
      }
      
      .container {
        padding: 0;
        width: 100%;
      }
      
      .card, .result-card {
        box-shadow: none;
        border: 1px solid #ddd;
        page-break-inside: avoid;
      }
      
      .theme-toggle, .language-selector, .no-print {
        display: none !important;
      }
      
      .chart-container {
        height: 200px;
      }
      
      h1 {
        font-size: 1.8rem;
      }
      
      h2 {
        font-size: 1.5rem;
      }
      
      .result-card::before, .card::before {
        display: none;
      }
      
      .print-container {
        display: block !important;
        width: 100%;
      }
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideIn {
      from {
        transform: translateX(-20px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes scaleIn {
      from {
        transform: scale(0.95);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }
      
      .card {
        padding: 1.5rem;
      }
      
      h1 {
        font-size: 1.8rem;
        margin: 1.5rem 0;
      }
      
      .button-group {
        flex-direction: column;
        gap: 1rem;
      }
      
      button {
        width: 100%;
        padding: 12px 20px;
      }
      
      .theme-toggle {
        right: 10px;
        top: 10px;
      }
      
      .language-selector {
        left: 10px;
        top: 10px;
      }
      
      .header-container {
        margin-top: 60px;
      }
      
      .boc-meeting {
        top: 15px;
        right: 40px;
        padding: 6px 12px;
        font-size: 0.8rem;
        max-width: calc(100% - 120px);
      }
      
      .detail-row {
        grid-template-columns: 1fr;
        gap: 0.5rem;
      }
      
      .payment-details-container {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      
      .step {
        width: 36px;
        height: 36px;
      }
      
      .result-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }
      
      .ratio-text {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .personalization-toast {
        width: 90%;
        max-width: 300px;
        text-align: center;
        font-size: 0.9rem;
        padding: 0.75rem 1rem;
      }
      
      .fixed-appointment {
        bottom: 15px;
        padding: 10px 16px;
        font-size: 0.9rem;
      }
      
      #personalization-trigger {
        right: 10px;
        bottom: 15px;
        padding: 10px 16px;
        font-size: 0.9rem;
      }
      
      .payment-option-card {
        padding: 1rem;
      }
      
      .payment-option-amount {
        font-size: 1.5rem;
      }
    }

    /* Enhanced Mobile Responsive Design */
    @media (max-width: 480px) {
      .card {
        padding: 1rem;
        margin: 1rem 0;
        border-radius: 8px;
      }

      .step-indicator {
        margin: 1rem 0;
      }

      .step {
        width: 32px;
        height: 32px;
        font-size: 0.9rem;
      }
      
      h1 {
        font-size: 1.5rem;
      }
      
      h2 {
        font-size: 1.3rem;
      }
      
      h3 {
        font-size: 1.1rem;
      }

      .form-group {
        margin-bottom: 0.75rem;
      }

      input[type="number"], 
      input[type="text"], 
      input[type="email"], 
      select {
        padding: 10px 12px;
        font-size: 0.95rem;
        min-height: 44px; /* Improve touch targets */
      }

      .button-group {
        gap: 0.75rem;
      }

      .result-card {
        padding: 1rem;
      }

      .max-amount .amount {
        font-size: 1.8rem;
      }

      .chart-container {
        height: 200px;
      }

      .modal-content {
        padding: 1rem;
        width: 95%;
        max-height: 85vh;
      }
      
      .seasonal-banner {
        padding: 1rem;
      }
      
      .campaign-title {
        font-size: 1rem;
      }
      
      .campaign-description {
        font-size: 0.85rem;
      }
      
      .cmhc-info-panel {
        padding: 0.75rem;
      }
      
      .cmhc-info-list {
        font-size: 0.8rem;
      }
      
      .cmhc-info-list li {
        margin-bottom: 0.75rem;
      }
      
      .boc-meeting {
        max-width: calc(100% - 100px);
        font-size: 0.75rem;
        padding: 4px 8px;
        right: 20px;
      }
      
      .boc-meeting-details {
        max-width: 85vw;
        padding: 10px;
      }
      
      #personalization-trigger,
      .fixed-appointment {
        font-size: 0.8rem;
        padding: 8px 12px;
      }
    }
    
    /* Extra Small Screens */
    @media (max-width: 360px) {
      h1 {
        font-size: 1.3rem;
      }
      
      .card {
        padding: 0.75rem;
      }
      
      .boc-meeting {
        right: 50px;
        max-width: calc(100% - 100px);
      }
      
      .theme-toggle {
        padding: 0.3rem;
      }
      
      .theme-toggle svg {
        width: 20px;
        height: 20px;
      }
      
      .language-selector {
        padding: 0.2rem 0.3rem;
      }
      
      .language-selector select {
        font-size: 0.75rem;
      }
      
      .step {
        width: 28px;
        height: 28px;
        font-size: 0.8rem;
      }
      
      .detail-label, .detail-section {
        font-size: 0.85rem;
      }
    }

    .payment-comparison {
      margin-bottom: 1rem;
    }

    .calculated-payment, 
    .mortgage-product-description {
      margin-top: 8px;
      font-size: 0.9rem;
      color: var(--accent-color);
      font-weight: 500;
    }

    .mortgage-product-description {
      padding: 10px;
      border-left: 3px solid var(--primary-color);
      background-color: rgba(255, 215, 0, 0.1);
      margin-top: 10px;
      border-radius: 0 5px 5px 0;
    }

    .cmhc-info-panel {
      margin-top: 1rem;
      padding: 1rem;
      background-color: rgba(33, 150, 243, 0.1);
      border-left: 3px solid var(--info-color);
      border-radius: 0 5px 5px 0;
    }

    .cmhc-info-title {
      font-weight: 600;
      color: var(--info-color);
      margin-bottom: 0.5rem;
    }

    .cmhc-info-list {
      list-style-position: inside;
      margin-left: 0.5rem;
    }

    .cmhc-info-list li {
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    .toggle-switch-container {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--border-color);
      transition: .4s;
      border-radius: 24px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: var(--card-bg);
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
      background-color: var(--primary-color);
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }

    .seasonal-banner {
      text-align: center;
      background: var(--gradient-card);
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 2rem;
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 12px var(--shadow-color);
    }

    .campaign-title {
      font-size: 1.2rem;
      color: var(--primary-color);
      margin-bottom: 0.5rem;
      font-family: 'Playfair Display', serif;
    }

    .campaign-description {
      color: var(--accent-color);
      font-style: italic;
    }

    #personalization-trigger {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      padding: 12px 24px;
      background: var(--gradient-primary);
      border-radius: 50px;
      box-shadow: 0 4px 12px var(--shadow-color);
      cursor: pointer;
      transition: transform 0.3s ease;
    }

    #personalization-trigger:hover {
      transform: translateY(-2px);
    }
    
    /* CSS for enhanced meeting button and CTAs */
    .meeting-cta {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      padding: 10px 20px;
      z-index: 100;
      border: 1px solid var(--accent-color);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      overflow: hidden;
      cursor: pointer;
      min-width: 250px;
    }

    .meeting-cta:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 25px rgba(0,0,0,0.25);
    }

    .cta-pulse {
      position: absolute;
      top: 16px;
      left: 16px;
      height: 10px;
      width: 10px;
      border-radius: 50%;
      background-color: #4CAF50;
      box-shadow: 0 0 0 rgba(76, 175, 80, 0.4);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(76, 175, 80, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
      }
    }

    .meeting-button {
      display: flex;
      align-items: center;
      gap: 12px;
      position: relative;
    }

    .meeting-icon {
      font-size: 1.4rem;
      margin-right: 4px;
    }

    .meeting-text {
      display: flex;
      flex-direction: column;
    }

    .meeting-title {
      font-weight: 600;
      color: var(--primary-color);
      font-size: 0.95rem;
    }

    .meeting-subtitle {
      font-size: 0.8rem;
      opacity: 0.8;
    }

    /* Results CTA */
    .results-cta {
      background: #000000;  /* Black background for dark mode */
      margin: 1.5rem 0;
      padding: 1.5rem;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .results-cta-text {
      flex: 1;
      min-width: 200px;
    }

    .results-cta-text h4 {
      color: white;
      margin-bottom: 0.5rem;
      font-weight: 700;
    }

    .results-cta-text p {
      color: rgba(255, 255, 255, 0.9);
      font-size: 0.9rem;
    }

    .results-cta-button {
      background: white;
      color: black;
      font-weight: 600;
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    .results-cta-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.15);
    }

    /* Inline CTAs */
    .inline-cta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: rgba(76, 175, 80, 0.1);
      border: 1px dashed var(--accent-color);
      padding: 10px 15px;
      border-radius: 6px;
      margin-top: 8px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .inline-cta span {
      font-size: 0.9rem;
      color: var(--accent-color);
    }

    .inline-cta-btn {
      background-color: var(--accent-color);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      font-weight: 500;
      font-size: 0.85rem;
      cursor: pointer;
      transition: background-color 0.2s;
      white-space: nowrap;
    }

    .inline-cta-btn:hover {
      background-color: var(--accent-dark);
    }

    /* Booking Modal */
    .booking-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      z-index: 1001;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(3px);
    }

    .booking-modal.active {
      display: flex;
      animation: fadeIn 0.3s ease;
    }

    .booking-modal-content {
      background: var(--card-bg);
      border-radius: 12px;
      width: 90%;
      max-width: 700px;
      max-height: 90vh;
      overflow-y: auto;
      padding: 2rem;
      position: relative;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      border: 1px solid var(--accent-color);
    }

    .close-booking-modal {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--accent-color);
      padding: 0;
      z-index: 1;
    }

    .booking-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .booking-header-left {
      flex: 2;
      min-width: 200px;
    }

    .booking-header-left h3 {
      margin-bottom: 0.5rem;
      color: var(--primary-color);
    }

    .booking-header-left p {
      color: var(--accent-color);
      font-size: 0.95rem;
    }

    .booking-header-right {
      flex: 1;
      min-width: 180px;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 10px;
      background: linear-gradient(120deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
      border: 1px solid var(--border-color);
    }

    .specialist-avatar img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--primary-color);
    }

    .specialist-info {
      flex: 1;
    }

    .specialist-name {
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 2px;
    }

    .specialist-title {
      font-size: 0.8rem;
      margin-bottom: 4px;
    }

    .specialist-rating {
      font-size: 0.8rem;
      color: var(--primary-color);
    }

    .booking-options {
      margin-bottom: 1.5rem;
    }

    .booking-options h4 {
      margin-bottom: 0.75rem;
      font-size: 1rem;
    }

    .time-slots {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 10px;
      margin-bottom: 1rem;
    }

    .time-slot {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      color: var(--text-color);
      padding: 10px;
      border-radius: 6px;
      text-align: center;
      font-size: 0.9rem;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    .time-slot:hover {
      border-color: var(--primary-color);
      transform: translateY(-2px);
    }

    .time-slot.selected {
      background-color: var(--primary-color);
      color: black;
      border-color: var(--primary-color);
      transform: none;
    }

    .or-divider {
      text-align: center;
      position: relative;
      margin: 1rem 0;
    }

    .or-divider::before, .or-divider::after {
      content: "";
      position: absolute;
      top: 50%;
      width: calc(50% - 30px);
      height: 1px;
      background-color: var(--border-color);
    }

    .or-divider::before {
      left: 0;
    }

    .or-divider::after {
      right: 0;
    }

    .view-calendar-btn {
      display: block;
      text-align: center;
      margin: 0 auto;
      background: none;
      border: 1px solid var(--accent-color);
      color: var(--accent-color);
      padding: 10px 16px;
      border-radius: 6px;
      font-weight: 500;
      text-decoration: none;
      transition: all 0.2s;
      font-size: 0.9rem;
    }

    .view-calendar-btn:hover {
      background-color: rgba(41, 128, 185, 0.1);
    }

    .booking-form {
      margin-top: 1.5rem;
    }

    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .booking-form .form-group {
      flex: 1;
      min-width: 180px;
    }

    .booking-form label {
      font-size: 0.9rem;
      margin-bottom: 4px;
    }

    .booking-form input, .booking-form select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 0.95rem;
    }

    .confirm-booking-btn {
      width: 100%;
      padding: 12px;
      margin-top: 1rem;
      background: var(--accent-color);
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .confirm-booking-btn:hover {
      background: var(--accent-dark);
      transform: translateY(-2px);
    }

    .booking-benefits {
      display: flex;
      justify-content: space-between;
      margin-top: 1.5rem;
      border-top: 1px solid var(--border-color);
      padding-top: 1.5rem;
      flex-wrap: wrap;
      gap: 10px;
    }

    .benefit {
      flex: 1;
      min-width: 150px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .benefit-icon {
      font-size: 1.2rem;
    }

    .benefit-text {
      font-size: 0.85rem;
    }

    .booking-confirmation {
      text-align: center;
      padding: 2rem 0;
    }

    .confirmation-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      color: var(--success-color);
    }

    .close-confirmation {
      margin-top: 1.5rem;
      padding: 10px 20px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    @media (max-width: 768px) {
      .meeting-cta {
        width: calc(100% - 40px);
      }
      
      .time-slots {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .booking-header {
        flex-direction: column;
      }
    }

    @media (max-width: 480px) {
      .meeting-cta {
        bottom: 15px;
        right: 15px;
        width: calc(100% - 30px);
        min-width: 0;
        padding: 8px 15px;
        z-index: 10;
      }
      
      .meeting-title {
        font-size: 0.9rem;
      }
      
      .meeting-subtitle {
        font-size: 0.75rem;
      }
      
      .booking-modal-content {
        padding: 1.5rem;
      }
      
      .time-slots {
        grid-template-columns: 1fr 1fr;
      }
      
      .form-row {
        flex-direction: column;
        gap: 0.75rem;
      }
      
      /* Add additional padding to the bottom of the page to prevent the fixed CTA from covering content */
      body {
        padding-bottom: 80px;
      }
      
      /* Make result page buttons stack and fit better on mobile */
      .results-container .button-group {
        flex-direction: column;
        gap: 0.75rem;
      }
      
      /* Fix the position of inline CTAs on small screens */
      .inline-cta {
        flex-direction: column;
        align-items: flex-start;
        padding: 12px;
      }
      
      .inline-cta-btn {
        width: 100%;
        margin-top: 8px;
        text-align: center;
      }
    }

    /* Add tooltip styles */
    .term-info {
      display: inline-block;
      width: 16px;
      height: 16px;
      background-color: var(--accent-color);
      color: white;
      border-radius: 50%;
      text-align: center;
      line-height: 16px;
      font-size: 12px;
      cursor: pointer;
      margin-left: 5px;
      vertical-align: middle;
      transition: all 0.2s ease;
    }

    .term-info:hover {
      background-color: var(--primary-color);
      transform: scale(1.1);
    }

    .tooltip {
      position: absolute;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 10px 15px;
      font-size: 0.9rem;
      max-width: 300px;
      box-shadow: 0 4px 12px var(--shadow-color);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .tooltip.show {
      opacity: 1;
      visibility: visible;
    }

    .tooltip::before {
      content: '';
      position: absolute;
      top: -6px;
      left: 20px;
      width: 10px;
      height: 10px;
      background: var(--card-bg);
      border-left: 1px solid var(--border-color);
      border-top: 1px solid var(--border-color);
      transform: rotate(45deg);
    }

    /* Add Calculator Button Styles */
    .calculator-cta {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 12px 24px;
        background: var(--primary-color);
        color: black;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        box-shadow: 0 4px 12px rgba(var(--shadow-color-rgb), 0.2);
    }

    .calculator-cta:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(var(--shadow-color-rgb), 0.3);
    }

    .calculator-cta .icon {
        font-size: 1.2rem;
    }

    /* Calculator Button Variations */
    .calculator-cta.floating {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 100;
        border-radius: 50px;
        padding: 12px 28px;
    }

    .calculator-cta.inline {
        margin: 1rem 0;
    }

    .calculator-cta.hero {
        font-size: 1.1rem;
        padding: 14px 32px;
    }

    @media (max-width: 768px) {
        .calculator-cta.floating {
            bottom: 15px;
            right: 15px;
            padding: 10px 20px;
            font-size: 0.9rem;
        }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="language-selector">
      <select id="language-select" aria-label="Select language">
        <option value="en">English</option>
        <option value="fr">Français</option>
        <option value="es">Español</option>
        <option value="ru">Русский</option>
      </select>
    </div>

    <!-- Add Blog Button -->
    <a href="blog.html" class="blog-button">
      <span class="blog-icon">📝</span>
      <span class="blog-text">Blog</span>
    </a>

    <div class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode">
      <svg viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="6" fill="currentColor"></circle>
        <g stroke="currentColor">
          <line x1="12" y1="1" x2="12" y2="3"></line>
          <line x1="12" y1="21" x2="12" y2="23"></line>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
          <line x1="1" y1="12" x2="3" y2="12"></line>
          <line x1="21" y1="12" x2="23" y2="12"></line>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </g>
      </svg>
    </div>
  
    <div class="header-container">
      <div class="boc-meeting">
        <span class="boc-meeting-icon">📅</span>
        <span class="boc-meeting-date">Next BOC Meeting: April 16, 2025</span>
        <div class="boc-meeting-details">
          <h4>Analyst Consensus</h4>
          <div class="consensus-item">
            <span class="consensus-label">Rate Increase:</span>
            <span class="consensus-value">25% probability</span>
          </div>
          <div class="consensus-item">
            <span class="consensus-label">Rate Decrease:</span>
            <span class="consensus-value">15% probability</span>
          </div>
          <div class="consensus-item">
            <span class="consensus-label">Rate Hold:</span>
            <span class="consensus-value">60% probability</span>
          </div>
          <div class="boc-sources">
            <div class="boc-source-item">
              <span class="boc-source-icon">🔗</span>
              <a href="https://www.bankofcanada.ca/" class="boc-source-link" target="_blank">Bank of Canada Official Site</a>
            </div>
            <div class="boc-source-item">
              <span class="boc-source-icon">📊</span>
              <a href="https://www.statcan.gc.ca/" class="boc-source-link" target="_blank">Statistics Canada</a>
            </div>
          </div>
        </div>
      </div>
      <h1 id="main-title">Montreal Mortgage Qualification Calculator</h1>
    </div>
    
    <!-- Form Container -->
    <div id="form-container" class="form-container active">
      <div class="seasonal-banner">
        <div class="campaign-title" id="campaign-title"></div>
        <div class="campaign-description" id="campaign-description"></div>
      </div>
      <div class="card">
        <div class="step-indicator">
          <div class="step active" data-step="1">1</div>
          <div class="step" data-step="2">2</div>
          <div class="step" data-step="3">3</div>
          <div class="step" data-step="4">4</div>
          <div class="progress-bar"><div class="progress"></div></div>
        </div>
        <!-- Step 1: Income Information -->
        <div class="step-content active" id="step-1">
          <h2 id="income-info-heading">Income Information</h2>
          <div class="form-group">
            <label for="income-period">Income Period</label>
            <select id="income-period">
              <option value="annual">Annual Income</option>
              <option value="monthly">Monthly Income</option>
            </select>
          </div>
          <div class="form-group">
            <label for="income-amount">Household Income</label>
            <div class="input-group">
              <span class="input-prefix">$</span>
              <input type="number" id="income-amount" min="0" step="1000" value="80000">
            </div>
          </div>
          <div class="form-group">
            <label for="include-co-applicant">Include Co-Applicant</label>
            <select id="include-co-applicant">
              <option value="no">No</option>
              <option value="yes">Yes</option>
            </select>
          </div>
          <div id="co-applicant-section" style="display: none;">
            <div class="form-group">
              <label for="co-applicant-income-period">Co-Applicant Income Period</label>
              <select id="co-applicant-income-period">
                <option value="annual">Annual Income</option>
                <option value="monthly">Monthly Income</option>
              </select>
            </div>
            <div class="form-group">
              <label for="co-applicant-income">Co-Applicant Income</label>
              <div class="input-group">
                <span class="input-prefix">$</span>
                <input type="number" id="co-applicant-income" min="0" step="1000" value="0">
              </div>
            </div>
          </div>
          
          <div class="button-group">
            <button class="button-next" id="step-1-next">Next: Debt Information</button>
          </div>
        </div>
        <!-- Step 2: Debt Information -->
        <div class="step-content" id="step-2">
          <h2 id="debt-info-heading">Debt Information</h2>
          <div class="form-group">
            <label for="credit-card-balance">Credit Card Balance</label>
            <div class="input-group">
              <span class="input-prefix">$</span>
              <input type="number" id="credit-card-balance" min="0" step="100" value="0">
            </div>
            <div id="credit-card-payment" class="calculated-payment">Monthly Payment (3%): $0</div>
          </div>
          <div class="form-group">
            <label for="line-of-credit-balance">Line of Credit Balance</label>
            <div class="input-group">
              <span class="input-prefix">$</span>
              <input type="number" id="line-of-credit-balance" min="0" step="100" value="0">
            </div>
            <div id="line-of-credit-payment" class="calculated-payment">Monthly Payment (3%): $0</div>
          </div>
          <div class="form-group">
            <label for="car-loan">Monthly Car Loan/Lease Payment</label>
            <div class="input-group">
              <span class="input-prefix">$</span>
              <input type="number" id="car-loan" min="0" step="10" value="0">
            </div>
          </div>
          <div class="form-group">
            <label for="student-loan">Monthly Student Loan Payment</label>
            <div class="input-group">
              <span class="input-prefix">$</span>
              <input type="number" id="student-loan" min="0" step="10" value="0">
            </div>
          </div>
          <div class="form-group">
            <label for="other-debts">Other Monthly Debt Payments</label>
            <div class="input-group">
              <span class="input-prefix">$</span>
              <input type="number" id="other-debts" min="0" step="10" value="0">
            </div>
          </div>
          <div class="button-group">
            <button class="secondary" id="step-2-prev">Previous</button>
            <button class="button-next" id="step-2-next">Next: Property Information</button>
          </div>
        </div>
        <!-- Step 3: Property Information -->
        <div class="step-content" id="step-3">
          <h2 id="property-info-heading">Property Information</h2>
          <div class="form-group">
            <div class="toggle-switch-container">
              <span class="toggle-label">Property Use:</span>
              <label class="toggle-switch">
                <input type="checkbox" id="owner-occupied-toggle">
                <span class="toggle-slider"></span>
              </label>
              <span class="toggle-label" id="property-use-label">Owner Occupied</span>
            </div>
          </div>
          <div class="form-group">
            <label for="property-type">Property Type</label>
            <select id="property-type">
              <option value="single-family">Single Family Home</option>
              <option value="condo">Condominium</option>
              <option value="townhouse">Townhouse</option>
              <option value="duplex">Duplex (2-unit)</option>
              <option value="triplex">Triplex (3-unit)</option>
              <option value="fourplex">Fourplex (4-unit)</option>
              <option value="five-plus-units">5+ Unit Building (Commercial)</option>
            </select>
          </div>
          <div class="cmhc-info-panel">
            <div class="cmhc-info-title">CMHC Down Payment Requirements:</div>
            <div id="cmhc-requirements">
              <ul class="cmhc-info-list">
                <li><strong>1-unit Properties (Owner-occupied):</strong> 5% minimum for home values up to $500,000; 5% on first $500,000 and 10% on remainder for homes between $500,000 and $999,999</li>
                <li><strong>2-4 unit Properties (Owner-occupied):</strong> 5% minimum for duplexes; 10% minimum for triplexes and fourplexes</li>
                <li><strong>Investment Properties (Non-owner occupied):</strong> 20% minimum down payment required</li>
                <li><strong>5+ Unit Properties (Commercial):</strong> 25% minimum down payment required (conventional financing only)</li>
                <li><strong>Properties over $1,000,000:</strong> 20% minimum down payment (not eligible for CMHC insurance)</li>
              </ul>
            </div>
          </div>
          <div class="form-group">
            <label for="property-location">Property Location</label>
            <select id="property-location">
              <option value="montreal">Montreal</option>
              <option value="vancouver">Vancouver</option>
              <option value="toronto">Toronto</option>
              <option value="ottawa">Ottawa</option>
              <option value="calgary">Calgary</option>
              <option value="edmonton">Edmonton</option>
              <option value="regina">Regina</option>
              <option value="other">Other</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="property-price">Property Price</label>
            <div class="input-group">
              <span class="input-prefix">$</span>
              <input type="number" id="property-price" min="0" step="1000" value="500000">
              <input type="range" id="property-price-slider" min="100000" max="2000000" step="1000" value="500000">
            </div>
          </div>
          <div class="form-group">
            <label for="down-payment">Down Payment</label>
            <div class="input-group">
              <span class="input-prefix">$</span>
              <input type="number" id="down-payment" min="0" step="1000" value="100000">
              <input type="range" id="down-payment-slider" min="0" max="500000" step="1000" value="100000">
            </div>
            <div id="min-down-payment-notice" class="calculated-payment">
              Minimum required: $25,000 (5%)
            </div>
          </div>
          <div class="form-group rental-income-section" style="display: none;">
            <label for="expected-rental-income">Expected Monthly Rental Income</label>
            <div class="input-group">
              <span class="input-prefix">$</span>
              <input type="number" id="expected-rental-income" min="0" step="100" value="0">
            </div>
            <div class="rental-income-notice calculated-payment">
              Qualifying rental income (80%): $0
            </div>
          </div>

          
          <div class="button-group">
            <button class="secondary" id="step-3-prev">Previous</button>
            <button class="button-next" id="step-3-next">Next: Expenses</button>
          </div>
        </div>

        <!-- Step 4: Monthly Expenses & Mortgage Details -->
        <div class="step-content" id="step-4">
          <h2 id="expenses-mortgage-heading">Monthly Expenses & Mortgage Details</h2>
          
          <div class="form-group">
            <label for="condo-fees">Monthly Condo Fees</label>
            <div class="input-group">
              <span class="input-prefix">$</span>
              <input type="number" id="condo-fees" min="0" step="0.01" value="0">
            </div>
          </div>
          
          <div class="form-group">
            <label for="municipal-tax">Annual Municipal Tax</label>
            <div class="input-group">
              <span class="input-prefix">$</span>
              <input type="number" id="municipal-tax" min="0" step="0.01" value="0">
            </div>
            <div id="municipal-tax-example" class="example-text"></div>
          </div>
          
          <div class="form-group">
            <label for="school-tax">Annual School Tax</label>
            <div class="input-group">
              <span class="input-prefix">$</span>
              <input type="number" id="school-tax" min="0" step="0.01" value="0">
            </div>
            <div id="school-tax-example" class="example-text"></div>
          </div>
          
          <div class="form-group">
            <label for="heating-fees">Monthly Heating Fees</label>
            <div class="input-group">
              <span class="input-prefix">$</span>
              <input type="number" id="heating-fees" min="0" step="0.01" value="0">
            </div>
          </div>
          
          <div class="form-group">
            <label for="interest-rate">Interest Rate (%)</label>
            <div class="input-group">
              <input type="number" id="interest-rate" min="0" max="20" step="0.01" value="5.25">
              <input type="range" id="interest-rate-slider" min="0" max="20" step="0.01" value="5.25">
            </div>
          </div>
          
          <div class="form-group">
            <label for="mortgage-product">Mortgage Product</label>
            <select id="mortgage-product">
              <option value="fixed">Fixed Rate</option>
              <option value="variable">Variable Rate</option>
              <option value="closed">Closed</option>
              <option value="open">Open</option>
              <option value="convertible">Convertible</option>
              <option value="cashback">Cash Back</option>
            </select>
            <div class="mortgage-product-description" id="mortgage-product-description"></div>
          </div>
          
          <div class="form-group">
            <label for="mortgage-term">Mortgage Term (Years)</label>
            <select id="mortgage-term">
              <option value="1">1 Year</option>
              <option value="2">2 Years</option>
              <option value="3">3 Years</option>
              <option value="4">4 Years</option>
              <option value="5" selected>5 Years</option>
              <option value="7">7 Years</option>
              <option value="10">10 Years</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="amortization-period">Amortization Period (Years)</label>
            <select id="amortization-period">
              <option value="10">10 Years</option>
              <option value="15">15 Years</option>
              <option value="20">20 Years</option>
              <option value="25" selected>25 Years</option>
              <option value="30">30 Years</option>
            </select>
          </div>
          


          <div class="button-group">
            <button class="secondary" id="step-4-prev">Previous</button>
            <button id="step-4-next">Calculate Qualification</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Results Container -->
    <div id="results-container" class="results-container">
      <div id="printable-content">
        <div class="result-card">
          <div class="result-header">
            <h2 id="qualification-summary-title">Mortgage Qualification Summary</h2>
          </div>
          
          <div class="qualification-status" id="qualification-status"></div>
          <div class="max-amount">
            <span id="max-amount-label">Maximum Qualification Amount:</span>
            <span class="amount" id="max-qualification-amount">$0</span>
          </div>
          <div class="result-item">
            <div class="label" id="mortgage-amount-label">Mortgage Amount</div>
            <div class="value" id="mortgage-amount">$0</div>
          </div>
          <div class="result-item">
            <div class="label" id="cmhc-insurance-label">CMHC Insurance Premium</div>
            <div class="value" id="cmhc-insurance">$0</div>
          </div>
          
          <div class="result-item payment-summary">
            <div class="payment-details-container">
              <div class="payment-option-card">
                <div class="payment-option-title">Monthly Payment</div>
                <div class="payment-option-amount" id="monthly-amount">$0</div>
                <div class="payment-option-frequency">12 payments/year</div>
              </div>
              <div class="payment-option-card">
                <div class="payment-option-title">Bi-Weekly Payment</div>
                <div class="payment-option-amount" id="biweekly-amount">$0</div>
                <div class="payment-option-frequency">26 payments/year</div>
              </div>
              <div class="payment-option-card">
                <div class="payment-option-title">Weekly Payment</div>
                <div class="payment-option-amount" id="weekly-amount">$0</div>
                <div class="payment-option-frequency">52 payments/year</div>
              </div>
            </div>
          </div>
          
          <div class="ratio-section">
            <div class="result-item">
              <div class="label" id="gds-ratio-label">GDS Ratio</div>
              <div class="value" id="gds-ratio">32%</div>
            </div>
            <div class="ratio-text">
              <span id="gds-threshold-text">GDS Threshold: <span id="gds-threshold-value">32%</span></span>
            </div>
            
            <div class="result-item">
              <div class="label" id="tds-ratio-label">TDS Ratio</div>
              <div class="value" id="tds-ratio">40%</div>
            </div>
            <div class="ratio-text">
              <span id="tds-threshold-text">TDS Threshold: <span id="tds-threshold-value">40%</span></span>
            </div>
          </div>
              
          <div class="result-item">
            <div class="label" id="stress-test-rate-label">Stress Test Rate</div>
            <div class="value" id="stress-test-rate">7.25%</div>
          </div>
          
          <button id="view-ratio-details" class="secondary no-print" style="margin-top: 15px;">
            View GDS/TDS Details
          </button>
        </div>
        
        <div class="result-card">
          <h3 id="payment-breakdown-title">Monthly Payment Breakdown</h3>
          <div class="chart-container">
            <canvas id="payment-chart"></canvas>
          </div>
        </div>
        <div class="result-card">
          <h3 id="recommendations-title">Recommendations</h3>
          <div id="recommendations-list"></div>
        </div>
      </div>
      
      <div class="button-group no-print" style="margin-top: 2rem;">
        <button class="secondary" id="recalculate-button">Recalculate</button>
        <button class="secondary" id="save-scenario">Save Scenario</button>
        <button class="secondary" id="print-results">Print Results</button>
      </div>
      
      <div id="comparison-container" style="display: none; margin-top: 2rem;">
        <h3 id="scenario-comparison-title">Scenario Comparison</h3>
        <div id="comparison-table"></div>
        <button id="clear-scenarios" class="secondary">Clear Scenarios</button>
      </div>
    </div>
  </div>

  <!-- Modal for GDS/TDS Details -->
  <div class="modal" id="ratio-details-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title">Qualification Ratio Details</h2>
        <button class="close-modal" id="close-modal-button">×</button>
      </div>
      
      <div class="detail-section">
        <h3 id="stress-test-info-title">Stress Test Information</h3>
        <div class="detail-row">
          <div class="detail-label" id="contract-rate-label">Contract Interest Rate:</div>
          <div id="modal-contract-rate">5.25%</div>
        </div>
        <div class="detail-row">
          <div class="detail-label" id="stress-rate-label">Stress Test Rate:</div>
          <div id="modal-stress-rate">7.25%</div>
        </div>
        <div class="detail-row">
          <div class="detail-label" id="contract-payment-label">Monthly Payment at Contract Rate:</div>
          <div id="modal-contract-payment">$2,350</div>
        </div>
        <div class="detail-row">
          <div class="detail-label" id="stress-payment-label">Monthly Payment at Stress Test Rate:</div>
          <div id="modal-stress-payment">$2,850</div>
        </div>
      </div>
      
      <div class="detail-section">
        <h3 id="gds-ratio-title">GDS Ratio: <span id="modal-gds-ratio">32.0%</span></h3>
        <p id="gds-explanation">Gross Debt Service ratio is the percentage of your income needed to pay all housing costs.</p>
        
        <div class="detail-row">
          <div class="detail-label" id="housing-costs-label">Monthly Housing Costs:</div>
          <div id="modal-housing-costs">$2,850</div>
        </div>
        
        <div class="detail-row">
          <div class="detail-label" id="monthly-income-label">Monthly Income:</div>
          <div id="modal-monthly-income">$8,333</div>
        </div>
        
        <div class="detail-row">
          <div class="detail-label" id="gds-threshold-label">GDS Threshold:</div>
          <div id="modal-gds-threshold">39%</div>
        </div>
        
        <div class="detail-row">
          <div class="detail-label" id="gds-calculation-label">GDS Calculation:</div>
          <div id="modal-gds-calculation">$2,850 ÷ $8,333 = 34.2%</div>
        </div>
      </div>
      
      <div class="detail-section">
        <h3 id="tds-ratio-title">TDS Ratio: <span id="modal-tds-ratio">38.0%</span></h3>
        <p id="tds-explanation">Total Debt Service ratio includes housing costs plus other debt obligations divided by monthly income.</p>
        
        <div class="detail-row">
          <div class="detail-label" id="tds-housing-label">Housing Costs:</div>
          <div id="modal-tds-housing">$2,850</div>
        </div>
        
        <div class="detail-row">
          <div class="detail-label" id="other-debts-label">Other Debt Payments:</div>
          <div id="modal-other-debts">$400</div>
        </div>
        
        <div class="detail-row">
          <div class="detail-label" id="total-obligations-label">Total Monthly Obligations:</div>
          <div id="modal-total-obligations">$3,250</div>
        </div>
        
        <div class="detail-row">
          <div class="detail-label" id="tds-income-label">Monthly Income:</div>
          <div id="modal-tds-income">$8,333</div>
        </div>
        
        <div class="detail-row">
          <div class="detail-label" id="tds-threshold-label">TDS Threshold:</div>
          <div id="modal-tds-threshold">44%</div>
        </div>
        
        <div class="detail-row">
          <div class="detail-label" id="tds-calculation-label">TDS Calculation:</div>
          <div id="modal-tds-calculation">$3,250 ÷ $8,333 = 39.0%</div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button id="close-modal" class="secondary">Close</button>
      </div>
    </div>
  </div>


  
  <div class="meeting-cta fixed-appointment" id="calendly-trigger">
    <div class="cta-pulse"></div>
    <div class="meeting-button">
      <div class="meeting-icon">📱</div>
      <div class="meeting-text">
        <div class="meeting-title">Speak with a Mortgage Expert</div>
        <div class="meeting-subtitle">Available now • 15 min free consultation</div>
      </div>
    </div>
  </div>
  
  <script>
    // Fix for mortgage calculation issue
    function fixMortgageCalculation() {
      // Override the calculateMortgage function with a corrected version
      window.calculateMortgage = function() {
        // First, validate that required fields are filled in
        const requiredFields = [
          { id: 'income-amount', label: 'Household Income' },
          { id: 'property-price', label: 'Property Price' },
          { id: 'down-payment', label: 'Down Payment' },
          { id: 'interest-rate', label: 'Interest Rate' }
        ];
        
        let missingFields = [];
        
        requiredFields.forEach(field => {
          const element = document.getElementById(field.id);
          if (!element || !element.value || parseFloat(element.value) === 0) {
            missingFields.push(field.label);
          }
        });
        
        if (missingFields.length > 0) {
          alert(`Please fill in the following required fields:\n- ${missingFields.join('\n- ')}`);
          return;
        }
        
        // Show loading state
        const loadingOverlay = document.createElement('div');
        loadingOverlay.className = 'loading-overlay';
        loadingOverlay.innerHTML = `
          <div class="loading-message">
            <div class="spinner"></div>
            <p style="margin-top: 20px;">Calculating your mortgage qualification...</p>
          </div>
        `;
        document.body.appendChild(loadingOverlay);
        
        setTimeout(function() {
          try {
            // Get form values
            const propertyPrice = parseFloat(document.getElementById('property-price').value) || 0;
            const downPayment = parseFloat(document.getElementById('down-payment').value) || 0;
            const interestRate = parseFloat(document.getElementById('interest-rate').value) || 0;
            const amortizationPeriod = parseInt(document.getElementById('amortization-period').value) || 25;
            
            // Get expenses
            const condoFees = parseFloat(document.getElementById('condo-fees').value) || 0;
            const municipalTax = parseFloat(document.getElementById('municipal-tax').value) || 0;
            const schoolTax = parseFloat(document.getElementById('school-tax').value) || 0;
            const heatingFees = parseFloat(document.getElementById('heating-fees').value) || 0;
            
            // Calculate monthly tax payments
            const monthlyMunicipalTax = municipalTax / 12;
            const monthlySchoolTax = schoolTax / 12;
            
            // Basic mortgage calculations
            const mortgageAmount = propertyPrice - downPayment;
            const ltv = (mortgageAmount / propertyPrice) * 100;
            
            // Calculate monthly payment
            // This is the PMT formula for mortgage payments
            const monthlyRate = interestRate / 100 / 12;
            const totalPayments = amortizationPeriod * 12;
            let monthlyPayment = 0;
            
            if (monthlyRate === 0) {
              monthlyPayment = mortgageAmount / totalPayments;
            } else {
              monthlyPayment = mortgageAmount * monthlyRate * Math.pow(1 + monthlyRate, totalPayments) / 
                              (Math.pow(1 + monthlyRate, totalPayments) - 1);
            }
            
            console.log("Monthly payment:", monthlyPayment);
            
            // Update payment amounts in UI
            document.getElementById('monthly-amount').textContent = '$' + monthlyPayment.toFixed(2);
            document.getElementById('biweekly-amount').textContent = '$' + ((monthlyPayment * 12) / 26).toFixed(2);
            document.getElementById('weekly-amount').textContent = '$' + ((monthlyPayment * 12) / 52).toFixed(2);
            
            // Calculate income and debts
            const monthlyIncome = calculateTotalMonthlyIncome();
            const monthlyDebts = calculateTotalMonthlyDebts();
            
            // Calculate housing costs
            const totalHousingCosts = monthlyPayment + condoFees + monthlyMunicipalTax + monthlySchoolTax + heatingFees;
            
            // Calculate GDS and TDS ratios
            const gdsRatio = (totalHousingCosts / monthlyIncome) * 100;
            const tdsRatio = ((totalHousingCosts + monthlyDebts) / monthlyIncome) * 100;
            
            // Update GDS and TDS in UI
            document.getElementById('gds-ratio').textContent = gdsRatio.toFixed(1) + '%';
            document.getElementById('tds-ratio').textContent = tdsRatio.toFixed(1) + '%';
            
            // Calculate CMHC insurance if applicable
            let cmhcInsurance = 0;
            if (ltv > 80 && propertyPrice < 1000000) {
              const isInvestmentProperty = document.getElementById('owner-occupied-toggle').checked;
              const propertyTypeValue = document.getElementById('property-type').value;
              const is5PlusProperty = propertyTypeValue === 'five-plus-units';
              
              if (!isInvestmentProperty && !is5PlusProperty) {
                cmhcInsurance = calculateCMHCPremium(mortgageAmount, propertyPrice);
              }
            }
            
            // Update CMHC insurance in UI
            document.getElementById('cmhc-insurance').textContent = '$' + cmhcInsurance.toLocaleString();
            
            // Calculate max qualification amount
            // Using GDS and TDS limits to determine maximum qualification
            const gdsLimit = 0.32; // 32% GDS threshold
            const tdsLimit = 0.40; // 40% TDS threshold
            
            const maxGDSHousingCosts = monthlyIncome * gdsLimit;
            const maxTDSHousingCosts = (monthlyIncome * tdsLimit) - monthlyDebts;
            
            const maxHousingCosts = Math.min(maxGDSHousingCosts, maxTDSHousingCosts);
            const maxMortgagePayment = maxHousingCosts - condoFees - monthlyMunicipalTax - monthlySchoolTax - heatingFees;
            
            let maxQualificationAmount = 0;
            if (maxMortgagePayment > 0) {
              if (monthlyRate === 0) {
                maxQualificationAmount = maxMortgagePayment * totalPayments;
              } else {
                maxQualificationAmount = maxMortgagePayment * (Math.pow(1 + monthlyRate, totalPayments) - 1) / 
                                        (monthlyRate * Math.pow(1 + monthlyRate, totalPayments));
              }
            }
            
            // Update max qualification amount in UI
            document.getElementById('max-qualification-amount').textContent = '$' + Math.round(maxQualificationAmount).toLocaleString();
            
            // Update mortgage amount
            document.getElementById('mortgage-amount').textContent = '$' + mortgageAmount.toLocaleString();
            
            // Update qualification status
            const qualificationStatus = document.getElementById('qualification-status');
            if (gdsRatio <= 32 && tdsRatio <= 40) {
              qualificationStatus.className = 'qualification-status approved';
              qualificationStatus.textContent = 'Approved';
              qualificationStatus.setAttribute('data-status', 'approved');
            } else if (gdsRatio <= 35 && tdsRatio <= 42) {
              qualificationStatus.className = 'qualification-status warning';
              qualificationStatus.textContent = 'Approved with Conditions';
              qualificationStatus.setAttribute('data-status', 'conditions');
            } else {
              qualificationStatus.className = 'qualification-status denied';
              qualificationStatus.textContent = 'Not Qualified';
              qualificationStatus.setAttribute('data-status', 'denied');
            }
            
            // Create payment chart
            createPaymentChart(
              monthlyPayment * 0.6, // Principal portion
              monthlyPayment * 0.4, // Interest portion
              monthlyMunicipalTax + monthlySchoolTax,
              heatingFees,
              condoFees
            );
            
            // Generate recommendations
            generateRecommendations(
              propertyPrice,
              downPayment,
              ltv,
              mortgageAmount,
              cmhcInsurance,
              gdsRatio,
              tdsRatio,
              32,
              40,
              monthlyIncome
            );
            
            // Switch to results view
            document.getElementById('form-container').classList.remove('active');
            document.getElementById('results-container').classList.add('active');
            
          } catch (error) {
            console.error('Calculation error:', error);
            alert('There was an error calculating your mortgage. Please check your inputs and try again.');
          } finally {
            loadingOverlay.remove();
          }
        }, 500);
      };
    }

    // Function to enhance meeting booking with CTAs
    function enhanceMeetingBooking() {
      // Add contextual CTA to results screen
      const resultsHeader = document.querySelector('.result-header');
      if (resultsHeader) {
        resultsHeader.insertAdjacentHTML('afterend', `
          <div class="results-cta">
            <div class="results-cta-text">
              <h4>Need help understanding your options?</h4>
              <p>Our mortgage specialists can explain your results and find you the best rates.</p>
            </div>
            <a href="javascript:void(0)" class="results-cta-button" id="results-cta-button">
              Schedule a Quick Chat
            </a>
          </div>
        `);
        
        // Add click handler for results CTA button
        document.getElementById('results-cta-button').addEventListener('click', showBookingModal);
      }
      
      // Add inline CTAs at strategic points in the form
      const addStrategicCTAs = () => {
        // Add to down payment step (potential pain point)
        const downPaymentEl = document.getElementById('down-payment');
        if (downPaymentEl) {
          downPaymentEl.parentNode.insertAdjacentHTML('afterend', `
            <div class="inline-cta">
              <span>Need help with down payment options?</span>
              <button class="inline-cta-btn">Talk to an expert</button>
            </div>
          `);
        }
        
        // Add to interest rate step (value proposition)
        const interestRateEl = document.getElementById('interest-rate');
        if (interestRateEl) {
          interestRateEl.parentNode.insertAdjacentHTML('afterend', `
            <div class="inline-cta">
              <span>We can find you better rates than published ones!</span>
              <button class="inline-cta-btn">Get rate quotes</button>
            </div>
          `);
        }
        
        // Add event listeners to all inline CTAs
        document.querySelectorAll('.inline-cta-btn').forEach(btn => {
          btn.addEventListener('click', showBookingModal);
        });
      };
      
      addStrategicCTAs();
      
      // Add click handler for main meeting CTA
      const meetingCta = document.querySelector('.meeting-cta');
      if (meetingCta) {
        meetingCta.addEventListener('click', showBookingModal);
      }
    }
    
    // Function to open Calendly
    function showBookingModal() {
      // Open Calendly in a new tab using your provided link
      window.open('https://calendly.com/representant', '_blank');
    }
    
    // Load and initialize Calendly inline if preferred
    function initCalendlyInline() {
      const calendlyTrigger = document.getElementById('calendly-trigger');
      if (calendlyTrigger) {
        calendlyTrigger.addEventListener('click', function(e) {
          e.preventDefault();
          showBookingModal();
        });
      }
      
      // Also attach to any inline CTAs
      document.querySelectorAll('.inline-cta-btn, .results-cta-button').forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          showBookingModal();
        });
      });
    }
    
    // Make sure we initialize Calendly after DOM load
    document.addEventListener('DOMContentLoaded', function() {
      initCalendlyInline();
    });
    
    // Global variables for translation
    const translations = {
      en: {
        mainTitle: 'Montreal Mortgage Qualification Calculator',
        personalInfo: 'Personal Information',
        optionalFields: 'All fields in this section are optional. You may skip providing personal details.',
        firstName: 'First Name (Optional)',
        lastName: 'Last Name (Optional)',
        email: 'Email (Optional)',
        address: 'Address (Optional)',
        nextIncome: 'Next: Income Information',
        incomeInfo: 'Income Information',
        incomePeriod: 'Income Period',
        annualIncome: 'Annual Income',
        monthlyIncome: 'Monthly Income',
        householdIncome: 'Household Income',
        includeCoApplicant: 'Include Co-Applicant',
        yes: 'Yes',
        no: 'No',
        coApplicantIncomePeriod: 'Co-Applicant Income Period',
        coApplicantIncome: 'Co-Applicant Income',
        previous: 'Previous',
        nextDebt: 'Next: Debt Information',
        debtInfo: 'Debt Information',
        creditCardBalance: 'Credit Card Balance',
        monthlyPayment: 'Monthly Payment (3%):',
        lineOfCreditBalance: 'Line of Credit Balance',
        carLoanPayment: 'Monthly Car Loan/Lease Payment',
        studentLoanPayment: 'Monthly Student Loan Payment',
        otherDebtPayments: 'Other Monthly Debt Payments',
        nextProperty: 'Next: Property Information',
        propertyInfo: 'Property Information',
        propertyUseOwner: 'Owner Occupied',
        propertyUseInvestment: 'Investment Property',
        propertyType: 'Property Type',
        singleFamily: 'Single Family Home',
        condo: 'Condominium',
        townhouse: 'Townhouse',
        duplex: 'Duplex (2-unit)',
        triplex: 'Triplex (3-unit)',
        fourplex: 'Fourplex (4-unit)',
        fivePlusUnits: '5+ Unit Building (Commercial)',
        propertyLocation: 'Property Location',
        propertyPrice: 'Property Price',
        downPayment: 'Down Payment',
        minRequired: 'Minimum required:',
        rentalIncome: 'Expected Monthly Rental Income',
        qualifyingRentalIncome: 'Qualifying rental income (80%):',
        cmhcRequirementsTitle: 'CMHC Down Payment Requirements:',
        cmhcRequirements: {
          ownerOccupied1Unit: '<strong>1-unit Properties (Owner-occupied):</strong> 5% minimum for home values up to $500,000; 5% on first $500,000 and 10% on remainder for homes between $500,000 and $999,999',
          ownerOccupied2To4Unit: '<strong>2-4 unit Properties (Owner-occupied):</strong> 5% minimum for duplexes; 10% minimum for triplexes and fourplexes',
          investment: '<strong>Investment Properties (Non-owner occupied):</strong> 20% minimum down payment required',
          fivePlusUnits: '<strong>5+ Unit Properties (Commercial):</strong> 25% minimum down payment required (conventional financing only)',
          over1M: '<strong>Properties over $1,000,000:</strong> 20% minimum down payment (not eligible for CMHC insurance)'
        },
        paymentFrequency: 'Payment Frequency',
        monthly: 'Monthly',
        biweekly: 'Bi-Weekly',
        weekly: 'Weekly',
        nextExpenses: 'Next: Expenses',
        expensesAndMortgage: 'Monthly Expenses & Mortgage Details',
        condoFees: 'Monthly Condo Fees',
        municipalTax: 'Annual Municipal Tax',
        schoolTax: 'Annual School Tax',
        heatingFees: 'Monthly Heating Fees',
        interestRate: 'Interest Rate (%)',
        mortgageTerm: 'Mortgage Term (Years)',
        amortizationPeriod: 'Amortization Period (Years)',
        calculateButton: 'Calculate Qualification',
        results: {
          qualificationSummary: 'Mortgage Qualification Summary',
          qualification: {
            approved: 'Approved',
            conditions: 'Approved with Conditions',
            denied: 'Not Qualified'
          },
          paymentBreakdown: 'Monthly Payment Breakdown',
          recommendations: 'Recommendations',
          maxAmount: {
            label: 'Maximum Qualification Amount',
            note: 'Based on your income and debt ratios'
          },
          mortgageDetails: {
            amount: 'Mortgage Amount',
            term: 'Mortgage Term',
            payment: 'Monthly Payment',
            frequency: {
              title: 'Payment Options',
              monthly: 'Monthly Payment',
              biweekly: 'Bi-Weekly Payment',
              weekly: 'Weekly Payment'
            }
          },
          insurance: {
            cmhc: 'CMHC Insurance Premium',
            tax: 'Insurance Premium Tax',
            total: 'Total Insurance Cost'
          },
          taxes: {
            property: 'Property Tax',
            school: 'School Tax',
            monthly: 'Monthly Tax Payment'
          },
          ratios: {
            gds: 'GDS Ratio',
            tds: 'TDS Ratio',
            details: 'View Ratio Details',
            stress: 'Stress Test Rate',
            threshold: 'Threshold'
          },
          buttons: {
            recalculate: 'Recalculate',
            save: 'Save Scenario',
            print: 'Print Results',
            compare: 'Compare Scenarios',
            clear: 'Clear Scenarios'
          },
          chart: {
            principal: 'Principal',
            interest: 'Interest',
            propertyTax: 'Property Tax',
            schoolTax: 'School Tax',
            heating: 'Heating',
            condoFees: 'Condo Fees'
          }
        }
      },
      fr: {
        mainTitle: 'Calculateur de qualification hypothécaire de Montréal',
        personalInfo: 'Informations personnelles',
        optionalFields: 'Tous les champs de cette section sont facultatifs. Vous pouvez ne pas fournir de détails personnels.',
        firstName: 'Prénom (Facultatif)',
        lastName: 'Nom de famille (Facultatif)',
        email: 'Courriel (Facultatif)',
        address: 'Adresse (Facultatif)',
        nextIncome: 'Suite: Informations sur le revenu',
        incomeInfo: 'Informations sur le revenu',
        incomePeriod: 'Période de revenu',
        annualIncome: 'Revenu annuel',
        monthlyIncome: 'Revenu mensuel',
        householdIncome: 'Revenu du ménage',
        includeCoApplicant: 'Inclure un co-demandeur',
        yes: 'Oui',
        no: 'Non',
        coApplicantIncomePeriod: 'Période de revenu du co-demandeur',
        coApplicantIncome: 'Revenu du co-demandeur',
        previous: 'Précédent',
        nextDebt: 'Suite: Informations sur les dettes',
        debtInfo: 'Informations sur les dettes',
        creditCardBalance: 'Solde de carte de crédit',
        monthlyPayment: 'Paiement mensuel (3%) :',
        lineOfCreditBalance: 'Solde de marge de crédit',
        carLoanPayment: 'Paiement mensuel de prêt/location auto',
        studentLoanPayment: 'Paiement mensuel de prêt étudiant',
        otherDebtPayments: 'Autres paiements mensuels de dettes',
        nextProperty: 'Suite: Détails de la propriété',
        propertyInfo: 'Informations sur la propriété',
        propertyUseOwner: 'Propriétaire occupant',
        propertyUseInvestment: 'Propriété d\'investissement',
        propertyType: 'Type de propriété',
        singleFamily: 'Maison unifamiliale',
        condo: 'Copropriété',
        townhouse: 'Maison en rangée',
        duplex: 'Duplex (2 unités)',
        triplex: 'Triplex (3 unités)',
        fourplex: 'Quadruplex (4 unités)',
        fivePlusUnits: 'Immeuble de 5+ unités (Commercial)',
        propertyLocation: 'Emplacement de la propriété',
        propertyPrice: 'Prix de la propriété',
        downPayment: 'Mise de fonds',
        minRequired: 'Minimum requis :',
        rentalIncome: 'Revenu locatif mensuel prévu',
        qualifyingRentalIncome: 'Revenu locatif admissible (80%) :',
        cmhcRequirementsTitle: 'Exigences de mise de fonds de la SCHL :',
        cmhcRequirements: {
          ownerOccupied1Unit: '<strong>Propriétés à 1 unité (Propriétaire occupant) :</strong> 5% minimum pour les valeurs jusqu\'à 500 000$; 5% sur les premiers 500 000$ et 10% sur le reste pour les propriétés entre 500 000$ et 999 999$',
          ownerOccupied2To4Unit: '<strong>Propriétés à 2-4 unités (Propriétaire occupant) :</strong> 5% minimum pour les duplex; 10% minimum pour les triplex et quadruplex',
          investment: '<strong>Propriétés d\'investissement (Non occupées par le propriétaire) :</strong> 20% minimum de mise de fonds requise',
          fivePlusUnits: '<strong>Propriétés à 5+ unités (Commercial) :</strong> 25% minimum de mise de fonds requise (financement conventionnel uniquement)',
          over1M: '<strong>Propriétés de plus de 1 000 000$ :</strong> 20% minimum de mise de fonds (non admissibles à l\'assurance SCHL)'
        },
        paymentFrequency: 'Fréquence de paiement',
        monthly: 'Mensuel',
        biweekly: 'Bimensuel',
        weekly: 'Hebdomadaire',
        nextExpenses: 'Suite: Dépenses',
        expensesAndMortgage: 'Dépenses mensuelles et détails du prêt',
        condoFees: 'Frais de copropriété mensuels',
        municipalTax: 'Taxe municipale annuelle',
        schoolTax: 'Taxe scolaire annuelle',
        heatingFees: 'Frais de chauffage mensuels',
        interestRate: 'Taux d\'intérêt (%)',
        mortgageTerm: 'Durée du prêt (Années)',
        amortizationPeriod: 'Période d\'amortissement (Années)',
        calculateButton: 'Calculer la qualification',
        results: {
          qualificationSummary: 'Résumé de Qualification Hypothécaire',
          qualification: {
            approved: 'Approuvé',
            conditions: 'Approuvé avec Conditions',
            denied: 'Non Qualifié'
          },
          paymentBreakdown: 'Répartition des Paiements Mensuels',
          recommendations: 'Recommandations',
          maxAmount: {
            label: 'Montant Maximum de Qualification',
            note: 'Basé sur vos revenus et ratios d\'endettement'
          },
          mortgageDetails: {
            amount: 'Montant du Prêt',
            term: 'Durée du Prêt',
            payment: 'Paiement Mensuel',
            frequency: {
              title: 'Options de Paiement',
              monthly: 'Paiement Mensuel',
              biweekly: 'Paiement Bimensuel',
              weekly: 'Paiement Hebdomadaire'
            }
          },
          insurance: {
            cmhc: 'Prime d\'Assurance SCHL',
            tax: 'Taxe sur Prime d\'Assurance',
            total: 'Coût Total d\'Assurance'
          },
          taxes: {
            property: 'Taxe Foncière',
            school: 'Taxe Scolaire',
            monthly: 'Paiement Mensuel des Taxes'
          },
          ratios: {
            gds: 'Ratio ABD',
            tds: 'Ratio ATD',
            details: 'Voir les Détails des Ratios',
            stress: 'Taux du Test de Résistance',
            threshold: 'Seuil'
          },
          buttons: {
            recalculate: 'Recalculer',
            save: 'Enregistrer le Scénario',
            print: 'Imprimer les Résultats',
            compare: 'Comparer les Scénarios',
            clear: 'Effacer les Scénarios'
          },
          chart: {
            principal: 'Principal',
            interest: 'Intérêt',
            propertyTax: 'Taxe Foncière',
            schoolTax: 'Taxe Scolaire',
            heating: 'Chauffage',
            condoFees: 'Frais de Copropriété'
          }
        }
      },
      es: {
        mainTitle: 'Calculadora de Calificación Hipotecaria de Montreal',
        personalInfo: 'Información Personal',
        optionalFields: 'Todos los campos en esta sección son opcionales. Puede omitir proporcionar detalles personales.',
        firstName: 'Nombre (Opcional)',
        lastName: 'Apellido (Opcional)',
        email: 'Correo Electrónico (Opcional)',
        address: 'Dirección (Opcional)',
        nextIncome: 'Siguiente: Información de Ingresos',
        incomeInfo: 'Información de Ingresos',
        incomePeriod: 'Período de Ingresos',
        annualIncome: 'Ingresos Anuales',
        monthlyIncome: 'Ingresos Mensuales',
        householdIncome: 'Ingresos del Hogar',
        includeCoApplicant: 'Incluir Co-Solicitante',
        yes: 'Sí',
        no: 'No',
        coApplicantIncomePeriod: 'Período de Ingresos del Co-Solicitante',
        coApplicantIncome: 'Ingresos del Co-Solicitante',
        previous: 'Anterior',
        nextDebt: 'Siguiente: Información de Deudas',
        debtInfo: 'Información de Deudas',
        creditCardBalance: 'Saldo de Tarjeta de Crédito',
        monthlyPayment: 'Pago Mensual (3%):',
        lineOfCreditBalance: 'Saldo de Línea de Crédito',
        carLoanPayment: 'Pago Mensual de Préstamo/Arrendamiento de Auto',
        studentLoanPayment: 'Pago Mensual de Préstamo Estudiantil',
        otherDebtPayments: 'Otros Pagos Mensuales de Deudas',
        nextProperty: 'Siguiente: Información de la Propiedad',
        propertyInfo: 'Información de la Propiedad',
        propertyUseOwner: 'Ocupada por Propietario',
        propertyUseInvestment: 'Propiedad de Inversión',
        propertyType: 'Tipo de Propiedad',
        singleFamily: 'Casa Unifamiliar',
        condo: 'Condominio',
        townhouse: 'Casa Adosada',
        duplex: 'Dúplex (2 unidades)',
        triplex: 'Tríplex (3 unidades)',
        fourplex: 'Cuádruplex (4 unidades)',
        fivePlusUnits: 'Edificio de 5+ Unidades (Comercial)',
        propertyLocation: 'Ubicación de la Propiedad',
        propertyPrice: 'Precio de la Propiedad',
        downPayment: 'Pago Inicial',
        minRequired: 'Mínimo Requerido:',
        rentalIncome: 'Ingreso Mensual por Alquiler Esperado',
        qualifyingRentalIncome: 'Ingreso por alquiler calificable (80%):',
        cmhcRequirementsTitle: 'Requisitos de Pago Inicial CMHC:',
        cmhcRequirements: {
          ownerOccupied1Unit: '<strong>Propiedades de 1 unidad (Ocupada por propietario):</strong> 5% mínimo para valores hasta $500,000; 5% en los primeros $500,000 y 10% en el resto para casas entre $500,000 y $999,999',
          ownerOccupied2To4Unit: '<strong>Propiedades de 2-4 unidades (Ocupada por propietario):</strong> 5% mínimo para dúplex; 10% mínimo para tríplex y cuádruplex',
          investment: '<strong>Propiedades de inversión (No ocupadas por el propietario):</strong> 20% mínimo de pago inicial requerido',
          fivePlusUnits: '<strong>Propiedades de 5+ unidades (Comercial):</strong> 25% mínimo de pago inicial requerido (solo financiamiento convencional)',
          over1M: '<strong>Propiedades de más de $1,000,000:</strong> 20% mínimo de pago inicial (no elegibles para seguro CMHC)'
        },
        paymentFrequency: 'Frecuencia de pago',
        monthly: 'Mensual',
        biweekly: 'Quincenal',
        weekly: 'Semanal',
        nextExpenses: 'Siguiente: Gastos',
        expensesAndMortgage: 'Gastos Mensuales y Detalles de la Hipoteca',
        condoFees: 'Cuotas Mensuales de Condominio',
        municipalTax: 'Impuesto Municipal Anual',
        schoolTax: 'Impuesto Escolar Anual',
        heatingFees: 'Gastos Mensuales de Calefacción',
        interestRate: 'Tasa de Interés (%)',
        mortgageTerm: 'Plazo de la Hipoteca (Años)',
        amortizationPeriod: 'Período de Amortización (Años)',
        calculateButton: 'Calcular Calificación',
        results: {
          qualificationSummary: 'Resumen de Calificación Hipotecaria',
          qualification: {
            approved: 'Aprobado',
            conditions: 'Aprobado con Condiciones',
            denied: 'No Calificado'
          },
          paymentBreakdown: 'Desglose de Pagos Mensuales',
          recommendations: 'Recomendaciones',
          maxAmount: {
            label: 'Monto Máximo de Calificación',
            note: 'Basado en sus ingresos y ratios de deuda'
          },
          mortgageDetails: {
            amount: 'Monto de la Hipoteca',
            term: 'Plazo de la Hipoteca',
            payment: 'Pago Mensual',
            frequency: {
              title: 'Opciones de Pago',
              monthly: 'Pago Mensual',
              biweekly: 'Pago Quincenal',
              weekly: 'Pago Semanal'
            }
          },
          insurance: {
            cmhc: 'Prima de Seguro CMHC',
            tax: 'Impuesto sobre Prima de Seguro',
            total: 'Costo Total del Seguro'
          },
          taxes: {
            property: 'Impuesto Predial',
            school: 'Impuesto Escolar',
            monthly: 'Pago Mensual de Impuestos'
          },
          ratios: {
            gds: 'Ratio GDS',
            tds: 'Ratio TDS',
            details: 'Ver Detalles de Ratios',
            stress: 'Tasa de Prueba de Estrés',
            threshold: 'Umbral'
          },
          buttons: {
            recalculate: 'Recalcular',
            save: 'Guardar Escenario',
            print: 'Imprimir Resultados',
            compare: 'Comparar Escenarios',
            clear: 'Borrar Escenarios'
          },
          chart: {
            principal: 'Principal',
            interest: 'Interés',
            propertyTax: 'Impuesto Predial',
            schoolTax: 'Impuesto Escolar',
            heating: 'Calefacción',
            condoFees: 'Cuotas de Condominio'
          }
        }
      },
      ru: {
        mainTitle: 'Калькулятор оценки ипотеки Монреаля',
        personalInfo: 'Личная информация',
        optionalFields: 'Все поля в этом разделе необязательны. Вы можете пропустить предоставление личных данных.',
        firstName: 'Имя (необязательно)',
        lastName: 'Фамилия (необязательно)',
        email: 'Электронная почта (необязательно)',
        address: 'Адрес (необязательно)',
        nextIncome: 'Далее: Информация о доходах',
        incomeInfo: 'Информация о доходах',
        incomePeriod: 'Период дохода',
        annualIncome: 'Годовой доход',
        monthlyIncome: 'Ежемесячный доход',
        householdIncome: 'Доход домохозяйства',
        includeCoApplicant: 'Включить созаявителя',
        yes: 'Да',
        no: 'Нет',
        coApplicantIncomePeriod: 'Период дохода созаявителя',
        coApplicantIncome: 'Доход созаявителя',
        previous: 'Назад',
        nextDebt: 'Далее: Информация о долгах',
        debtInfo: 'Информация о долгах',
        creditCardBalance: 'Баланс кредитной карты',
        monthlyPayment: 'Ежемесячный платеж (3%):',
        lineOfCreditBalance: 'Баланс кредитной линии',
        carLoanPayment: 'Ежемесячный платеж по автокредиту/лизингу',
        studentLoanPayment: 'Ежемесячный платеж по студенческому кредиту',
        otherDebtPayments: 'Другие ежемесячные платежи по долгам',
        nextProperty: 'Далее: Информация о недвижимости',
        propertyInfo: 'Информация о недвижимости',
        propertyUseOwner: 'Проживание владельца',
        propertyUseInvestment: 'Инвестиционная недвижимость',
        propertyType: 'Тип недвижимости',
        singleFamily: 'Частный дом',
        condo: 'Кондоминиум',
        townhouse: 'Таунхаус',
        duplex: 'Дуплекс (2 квартиры)',
        triplex: 'Триплекс (3 квартиры)',
        fourplex: 'Четырехквартирный дом (4 квартиры)',
        fivePlusUnits: 'Здание с 5+ квартирами (Коммерческое)',
        propertyLocation: 'Местоположение недвижимости',
        propertyPrice: 'Цена недвижимости',
        downPayment: 'Первоначальный взнос',
        minRequired: 'Минимально требуется:',
        rentalIncome: 'Ожидаемый ежемесячный доход от аренды',
        qualifyingRentalIncome: 'Квалифицируемый доход от аренды (80%):',
        cmhcRequirementsTitle: 'Требования CMHC к первоначальному взносу:',
        cmhcRequirements: {
          ownerOccupied1Unit: '<strong>Недвижимость с 1 единицей (проживание владельца):</strong> Минимум 5% для стоимости до $500,000; 5% на первые $500,000 и 10% на остаток для домов между $500,000 и $999,999',
          ownerOccupied2To4Unit: '<strong>Недвижимость с 2-4 единицами (проживание владельца):</strong> Минимум 5% для дуплексов; минимум 10% для триплексов и четырехквартирных домов',
          investment: '<strong>Инвестиционная недвижимость (без проживания владельца):</strong> Требуется минимальный первоначальный взнос 20%',
          fivePlusUnits: '<strong>Недвижимость с 5+ единицами (Коммерческая):</strong> Требуется минимальный первоначальный взнос 25% (только традиционное финансирование)',
          over1M: '<strong>Недвижимость высокой стоимости:</strong> Минимальный первоначальный взнос 20% (не подлежит страхованию CMHC)'
        },
        paymentFrequency: 'Частота платежей',
        monthly: 'Ежемесячно',
        biweekly: 'Раз в две недели',
        weekly: 'Еженедельно',
        nextExpenses: 'Далее: Расходы',
        expensesAndMortgage: 'Ежемесячные расходы и детали ипотеки',
        condoFees: 'Ежемесячные сборы кондоминиума',
        municipalTax: 'Годовой муниципальный налог',
        schoolTax: 'Годовой школьный налог',
        heatingFees: 'Ежемесячные расходы на отопление',
        interestRate: 'Процентная ставка (%)',
        mortgageTerm: 'Срок ипотеки (лет)',
        amortizationPeriod: 'Период амортизации (лет)',
        calculateButton: 'Рассчитать квалификацию',
        results: {
          qualificationSummary: 'Результаты Оценки Ипотеки',
          qualification: {
            approved: 'Одобрено',
            conditions: 'Одобрено с Условиями',
            denied: 'Не Квалифицировано'
          },
          paymentBreakdown: 'Разбивка Ежемесячных Платежей',
          recommendations: 'Рекомендации',
          maxAmount: {
            label: 'Максимальная Сумма Квалификации',
            note: 'На основе ваших доходов и коэффициентов задолженности'
          },
          mortgageDetails: {
            amount: 'Сумма Ипотеки',
            term: 'Срок Ипотеки',
            payment: 'Ежемесячный Платеж',
            frequency: {
              title: 'Варианты Оплаты',
              monthly: 'Ежемесячный Платеж',
              biweekly: 'Двухнедельный Платеж',
              weekly: 'Еженедельный Платеж'
            }
          },
          insurance: {
            cmhc: 'Страховая Премия CMHC',
            tax: 'Налог на Страховую Премию',
            total: 'Общая Стоимость Страхования'
          },
          taxes: {
            property: 'Налог на Недвижимость',
            school: 'Школьный Налог',
            monthly: 'Ежемесячный Налоговый Платеж'
          },
          ratios: {
            gds: 'Коэффициент GDS',
            tds: 'Коэффициент TDS',
            details: 'Просмотр Деталей Коэффициентов',
            stress: 'Ставка Стресс-теста',
            threshold: 'Пороговое Значение'
          },
          buttons: {
            recalculate: 'Пересчитать',
            save: 'Сохранить Сценарий',
            print: 'Печать Результатов',
            compare: 'Сравнить Сценарии',
            clear: 'Очистить Сценарии'
          },
          chart: {
            principal: 'Основная Сумма',
            interest: 'Проценты',
            propertyTax: 'Налог на Недвижимость',
            schoolTax: 'Школьный Налог',
            heating: 'Отопление',
            condoFees: 'Плата за Кондоминиум'
          }
        }
      }
    };

    // Add BOC translations
    const bocTranslations = {
      en: {
        nextMeeting: "Next BOC Meeting:",
        analystConsensus: "Analyst Consensus",
        increase: "Rate Increase:",
        decrease: "Rate Decrease:",
        hold: "Rate Hold:",
        probability: "probability"
      },
      fr: {
        nextMeeting: "Prochaine réunion de la BdC:",
        analystConsensus: "Consensus des analystes",
        increase: "Hausse des taux:",
        decrease: "Baisse des taux:",
        hold: "Maintien des taux:",
        probability: "probabilité"
      },
      es: {
        nextMeeting: "Próxima reunión del BOC:",
        analystConsensus: "Consenso de analistas",
        increase: "Aumento de tasa:",
        decrease: "Reducción de tasa:",
        hold: "Mantener tasa:",
        probability: "probabilidad"
      },
      ru: {
        nextMeeting: "Следующее заседание Банка Канады:",
        analystConsensus: "Консенсус аналитиков",
        increase: "Повышение ставки:",
        decrease: "Понижение ставки:",
        hold: "Без изменений:",
        probability: "вероятность"
      }
    };

    // Utility functions
    function setTextContent(id, text) {
      const element = document.getElementById(id);
      if (element) {
        element.textContent = text;
      }
    }

    function setLabelText(forAttribute, text) {
      const label = document.querySelector('label[for="' + forAttribute + '"]');
      if (label) {
        label.textContent = text;
      }
    }

    function setOptionText(selectId, value, text) {
      const option = document.querySelector('#' + selectId + ' option[value="' + value + '"]');
      if (option) {
        option.textContent = text;
      }
    }

    function setInnerHTML(id, html) {
      const element = document.getElementById(id);
      if (element) {
        element.innerHTML = html;
      }
    }

    let currentLanguage = 'en';
    let paymentChart = null;
    let scenarios = [];

    // DOM References - initialize as null and get them only after DOM is fully loaded
    let step1Next, step2Prev, step2Next, step3Prev, step3Next, step4Prev, step4Next;
    let formContainer, resultsContainer, coApplicantSection;
    let propertyPrice, propertyPriceSlider, downPayment, downPaymentSlider, interestRate, interestRateSlider;
    let propertyType, propertyLocation, ownerOccupiedToggle, propertyUseLabel, expectedRentalIncome;
    let creditCardBalance, creditCardPayment, lineOfCreditBalance, lineOfCreditPayment, minDownPaymentNotice;
    let recalculateButton, saveScenarioButton, clearScenariosButton, viewRatioDetailsButton;
    let closeModalButton, closeModal, printResultsButton, ratioDetailsModal;
    let rentalIncomeSection, cmhcRequirementsElement, includeCoApplicant, paymentFrequency;

    // Initialize DOM elements after page is fully loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize DOM references safely
      initializeDOMReferences();
      
      // Setup event listeners
      setupEventListeners();
      
      // Check dark mode
      if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.documentElement.setAttribute('data-theme', 'dark');
      }
      
      // Add dark mode toggle
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(event) {
        if (event.matches) {
          document.documentElement.setAttribute('data-theme', 'dark');
        } else {
          document.documentElement.removeAttribute('data-theme');
        }
      });
      
      // Set initial language
      updateLanguage();
      
      // Enhance step navigation
      enhanceStepNavigation();
      
      // Enhance results visualization
      const updateVisuals = enhanceResultsVisualization();
      
      // Update the calculateMortgage function to include new visualizations
      const originalCalculateMortgage = calculateMortgage;
      calculateMortgage = function() {
        originalCalculateMortgage();
        updateVisuals();
      };

      // Initialize strategic CTAs
      enhanceMeetingBooking();
      
      // Initialize seasonal campaign
      updateSeasonalCampaign();
      enhanceProgressIndicator();
    });
    
    // Initialize DOM references safely
    function initializeDOMReferences() {
      // Navigation buttons
      step1Next = document.getElementById('step-1-next');
      step2Prev = document.getElementById('step-2-prev');
      step2Next = document.getElementById('step-2-next');
      step3Prev = document.getElementById('step-3-prev');
      step3Next = document.getElementById('step-3-next');
      step4Prev = document.getElementById('step-4-prev');
      step4Next = document.getElementById('step-4-next');
      
      // Containers
      formContainer = document.getElementById('form-container');
      resultsContainer = document.getElementById('results-container');
      coApplicantSection = document.getElementById('co-applicant-section');
      
      // Form inputs
      propertyPrice = document.getElementById('property-price');
      propertyPriceSlider = document.getElementById('property-price-slider');
      downPayment = document.getElementById('down-payment');
      downPaymentSlider = document.getElementById('down-payment-slider');
      interestRate = document.getElementById('interest-rate');
      interestRateSlider = document.getElementById('interest-rate-slider');
      propertyType = document.getElementById('property-type');
      propertyLocation = document.getElementById('property-location');
      ownerOccupiedToggle = document.getElementById('owner-occupied-toggle');
      propertyUseLabel = document.getElementById('property-use-label');
      expectedRentalIncome = document.getElementById('expected-rental-income');
      rentalIncomeSection = document.querySelector('.rental-income-section');
      creditCardBalance = document.getElementById('credit-card-balance');
      creditCardPayment = document.getElementById('credit-card-payment');
      lineOfCreditBalance = document.getElementById('line-of-credit-balance');
      lineOfCreditPayment = document.getElementById('line-of-credit-payment');
      minDownPaymentNotice = document.getElementById('min-down-payment-notice');
      cmhcRequirementsElement = document.getElementById('cmhc-requirements');
      includeCoApplicant = document.getElementById('include-co-applicant');
      paymentFrequency = document.getElementById('payment-frequency');
      
      // Results related elements
      recalculateButton = document.getElementById('recalculate-button');
      saveScenarioButton = document.getElementById('save-scenario');
      clearScenariosButton = document.getElementById('clear-scenarios');
      viewRatioDetailsButton = document.getElementById('view-ratio-details');
      closeModalButton = document.getElementById('close-modal-button');
      closeModal = document.getElementById('close-modal');
      printResultsButton = document.getElementById('print-results');
      ratioDetailsModal = document.getElementById('ratio-details-modal');
    }
    
    // Mortgage product descriptions
    const mortgageProductDescriptions = {
      fixed: "Fixed rate mortgages maintain the same interest rate throughout the term.",
      variable: "Variable rate mortgages have an interest rate that can fluctuate with market conditions.",
      closed: "Closed mortgages offer lower rates but have penalties for early repayment or refinancing.",
      open: "Open mortgages allow you to repay any amount at any time without penalty, but have higher rates.",
      convertible: "Convertible mortgages allow you to convert from a variable rate to a fixed rate during the term.",
      cashback: "Cash back mortgages provide you with a lump sum of cash upon closing, but often have higher rates."
    };
    
    // Setup event listeners safely
    function setupEventListeners() {
      if (step1Next) step1Next.addEventListener('click', function() { goToStep(2); });
      if (step2Prev) step2Prev.addEventListener('click', function() { goToStep(1); });
      if (step2Next) step2Next.addEventListener('click', function() { goToStep(3); });
      if (step3Prev) step3Prev.addEventListener('click', function() { goToStep(2); });
      if (step3Next) step3Next.addEventListener('click', function() { goToStep(4); });
      if (step4Prev) step4Prev.addEventListener('click', function() { goToStep(3); });
      if (step4Next) step4Next.addEventListener('click', calculateMortgage);
      
      // Mortgage product selection
      const mortgageProduct = document.getElementById('mortgage-product');
      const mortgageProductDescription = document.getElementById('mortgage-product-description');
      
      if (mortgageProduct && mortgageProductDescription) {
        mortgageProduct.addEventListener('change', function() {
          const selectedProduct = this.value;
          mortgageProductDescription.textContent = mortgageProductDescriptions[selectedProduct] || "";
        });
      }
      
      // Theme toggle
      const themeToggle = document.getElementById('theme-toggle');
      if (themeToggle) themeToggle.addEventListener('click', toggleTheme);
      
      // Language selector
      const languageSelect = document.getElementById('language-select');
      if (languageSelect) {
        languageSelect.addEventListener('change', function() {
          currentLanguage = this.value;
          updateLanguage();
          updateSeasonalCampaign();
        });
      }
      
      // Property Use Toggle
      if (ownerOccupiedToggle) {
        ownerOccupiedToggle.addEventListener('change', function() {
          if (this.checked) {
            propertyUseLabel.textContent = translations[currentLanguage]?.propertyUseInvestment || 'Investment Property';
          } else {
            propertyUseLabel.textContent = translations[currentLanguage]?.propertyUseOwner || 'Owner Occupied';
          }
          updateMinDownPaymentNotice();
          toggleRentalIncomeField();
        });
      }
      
      // Form inputs
      if (propertyPrice) {
        propertyPrice.addEventListener('input', function() {
          if (propertyPriceSlider) propertyPriceSlider.value = this.value;
          updateMinDownPaymentNotice();
          updateDownPaymentSlider();
        });
      }
      
      if (propertyPriceSlider) {
        propertyPriceSlider.addEventListener('input', function() {
          if (propertyPrice) propertyPrice.value = this.value;
          updateMinDownPaymentNotice();
          updateDownPaymentSlider();
        });
      }
      
      if (downPayment) {
        downPayment.addEventListener('input', function() {
          if (downPaymentSlider) downPaymentSlider.value = this.value;
          validateDownPayment();
        });
      }
      
      if (downPaymentSlider) {
        downPaymentSlider.addEventListener('input', function() {
          if (downPayment) downPayment.value = this.value;
          validateDownPayment();
        });
      }
      
      if (interestRate) {
        interestRate.addEventListener('input', function() {
          if (interestRateSlider) interestRateSlider.value = this.value;
        });
      }
      
      if (interestRateSlider) {
        interestRateSlider.addEventListener('input', function() {
          if (interestRate) interestRate.value = this.value;
        });
      }
      
      if (propertyType) {
        propertyType.addEventListener('change', function() {
          updateMinDownPaymentNotice();
          validateDownPayment();
          toggleRentalIncomeField();
        });
      }
      
      if (expectedRentalIncome) {
        expectedRentalIncome.addEventListener('input', updateRentalIncomeNotice);
      }
      
      if (creditCardBalance) {
        creditCardBalance.addEventListener('input', updateCreditCardPayment);
      }
      
      if (lineOfCreditBalance) {
        lineOfCreditBalance.addEventListener('input', updateLineOfCreditPayment);
      }
      
      if (includeCoApplicant) {
        includeCoApplicant.addEventListener('change', function() {
          if (coApplicantSection) {
            coApplicantSection.style.display = this.value === 'yes' ? 'block' : 'none';
          }
        });
      }
      
      if (propertyLocation) {
        propertyLocation.addEventListener('change', function() {
          updateTaxExamples(this.value);
        });
      }
      
      // Results actions
      if (recalculateButton) {
        recalculateButton.addEventListener('click', function() {
          if (resultsContainer && formContainer) {
            resultsContainer.classList.remove('active');
            formContainer.classList.add('active');
          }
        });
      }
      
      if (saveScenarioButton) {
        saveScenarioButton.addEventListener('click', saveScenario);
      }
      
      if (clearScenariosButton) {
        clearScenariosButton.addEventListener('click', clearScenarios);
      }
      
      // Modal
      if (viewRatioDetailsButton) {
        viewRatioDetailsButton.addEventListener('click', function() {
          if (ratioDetailsModal) {
            ratioDetailsModal.classList.add('active');
          }
        });
      }
      
      if (closeModalButton) {
        closeModalButton.addEventListener('click', function() {
          if (ratioDetailsModal) {
            ratioDetailsModal.classList.remove('active');
          }
        });
      }
      
      if (closeModal) {
        closeModal.addEventListener('click', function() {
          if (ratioDetailsModal) {
            ratioDetailsModal.classList.remove('active');
          }
        });
      }
      
      // Print results
      if (printResultsButton) {
        printResultsButton.addEventListener('click', function() {
          window.print();
        });
      }

      // Add tooltip functionality
      const termsToAdd = ['gdsRatio', 'tdsRatio', 'cmhcInsurance', 'amortization', 'downPayment', 'ltv', 'preApproval', 'mortgageTerm'];
      termsToAdd.forEach(term => {
        const label = document.querySelector(`label[for="${term}"]`);
        if (label) {
          const infoIcon = document.createElement('span');
          infoIcon.className = 'term-info';
          infoIcon.textContent = 'i';
          infoIcon.setAttribute('data-term', term);
          label.appendChild(infoIcon);
        }
      });

      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('term-info')) {
          const term = e.target.getAttribute('data-term');
          const currentLang = currentLanguage || 'en';
          const explanation = mortgageTerms[currentLang][term];
          
          document.querySelectorAll('.tooltip').forEach(t => t.remove());
          
          const tooltip = document.createElement('div');
          tooltip.className = 'tooltip';
          tooltip.textContent = explanation;
          
          const rect = e.target.getBoundingClientRect();
          tooltip.style.top = `${rect.bottom + window.scrollY + 10}px`;
          tooltip.style.left = `${rect.left + window.scrollX - 20}px`;
          
          document.body.appendChild(tooltip);
          
          setTimeout(() => tooltip.classList.add('show'), 10);
          
          const hideTooltip = function(e) {
            if (!e.target.classList.contains('term-info')) {
              tooltip.remove();
              document.removeEventListener('click', hideTooltip);
            }
          };
          
          document.addEventListener('click', hideTooltip);
        }
      });
    }
    
    // Toggle rental income field based on property type and occupancy
    function toggleRentalIncomeField() {
      if (!propertyType || !ownerOccupiedToggle || !rentalIncomeSection) return;
      
      const propertyTypeValue = propertyType.value;
      const isInvestmentProperty = ownerOccupiedToggle.checked;
      const isMultiUnit = ['duplex', 'triplex', 'fourplex', 'five-plus-units'].includes(propertyTypeValue);
      
      // Show rental income section for investment properties or multi-unit properties
      if (isInvestmentProperty || isMultiUnit) {
        rentalIncomeSection.style.display = 'block';
      } else {
        rentalIncomeSection.style.display = 'none';
      }
    }
    
    // Update language with null checks
    function updateLanguage() {
      const lang = translations[currentLanguage] || translations.en;
      
      // Main title
      setTextContent('main-title', lang.mainTitle);
      
      // Step 1
      setTextContent('income-info-heading', lang.incomeInfo);
      setLabelText('income-period', lang.incomePeriod);
      setOptionText('income-period', 'annual', lang.annualIncome);
      setOptionText('income-period', 'monthly', lang.monthlyIncome);
      setLabelText('income-amount', lang.householdIncome);
      setLabelText('include-co-applicant', lang.includeCoApplicant);
      setOptionText('include-co-applicant', 'yes', lang.yes);
      setOptionText('include-co-applicant', 'no', lang.no);
      setLabelText('co-applicant-income-period', lang.coApplicantIncomePeriod);
      setOptionText('co-applicant-income-period', 'annual', lang.annualIncome);
      setOptionText('co-applicant-income-period', 'monthly', lang.monthlyIncome);
      setLabelText('co-applicant-income', lang.coApplicantIncome);
      if (step1Next) step1Next.textContent = lang.nextDebt;
      
      // Step 2
      setTextContent('debt-info-heading', lang.debtInfo);
      setLabelText('credit-card-balance', lang.creditCardBalance);
      setLabelText('line-of-credit-balance', lang.lineOfCreditBalance);
      setLabelText('car-loan', lang.carLoanPayment);
      setLabelText('student-loan', lang.studentLoanPayment);
      setLabelText('other-debts', lang.otherDebtPayments);
      if (step2Prev) step2Prev.textContent = lang.previous;
      if (step2Next) step2Next.textContent = lang.nextProperty;
      
      // Update credit card and line of credit payment text
      updateCreditCardPayment();
      updateLineOfCreditPayment();
      
      // Step 3
      setTextContent('property-info-heading', lang.propertyInfo);
      if (propertyUseLabel) {
        propertyUseLabel.textContent = ownerOccupiedToggle && ownerOccupiedToggle.checked ? 
          lang.propertyUseInvestment : lang.propertyUseOwner;
      }
      setLabelText('property-type', lang.propertyType);
      setOptionText('property-type', 'single-family', lang.singleFamily);
      setOptionText('property-type', 'condo', lang.condo);
      setOptionText('property-type', 'townhouse', lang.townhouse);
      setOptionText('property-type', 'duplex', lang.duplex);
      setOptionText('property-type', 'triplex', lang.triplex);
      setOptionText('property-type', 'fourplex', lang.fourplex);
      setOptionText('property-type', 'five-plus-units', lang.fivePlusUnits);
      setLabelText('property-location', lang.propertyLocation);
      setLabelText('property-price', lang.propertyPrice);
      setLabelText('down-payment', lang.downPayment);
      setLabelText('expected-rental-income', lang.rentalIncome);
      setLabelText('payment-frequency', lang.paymentFrequency);
      setOptionText('payment-frequency', 'monthly', lang.monthly);
      setOptionText('payment-frequency', 'biweekly', lang.biweekly);
      setOptionText('payment-frequency', 'weekly', lang.weekly);
      
      // CMHC requirements title
      if (document.querySelector('.cmhc-info-title')) {
        document.querySelector('.cmhc-info-title').textContent = lang.cmhcRequirementsTitle;
      }
      
      // Update CMHC requirements list
      if (cmhcRequirementsElement) {
        let cmhcHTML = '<ul class="cmhc-info-list">';
        cmhcHTML += `<li>${lang.cmhcRequirements.ownerOccupied1Unit}</li>`;
        cmhcHTML += `<li>${lang.cmhcRequirements.ownerOccupied2To4Unit}</li>`;
        cmhcHTML += `<li>${lang.cmhcRequirements.investment}</li>`;
        cmhcHTML += `<li>${lang.cmhcRequirements.fivePlusUnits}</li>`;
        cmhcHTML += `<li>${lang.cmhcRequirements.over1M}</li>`;
        cmhcRequirementsElement.innerHTML = cmhcHTML;
      }
      
      if (step3Prev) step3Prev.textContent = lang.previous;
      if (step3Next) step3Next.textContent = lang.nextExpenses;
      
      // Update minimum down payment notice
      updateMinDownPaymentNotice();
      
      // Update rental income notice
      updateRentalIncomeNotice();
      
      // Step 4
      setTextContent('expenses-mortgage-heading', lang.expensesAndMortgage);
      setLabelText('condo-fees', lang.condoFees);
      setLabelText('municipal-tax', lang.municipalTax);
      setLabelText('school-tax', lang.schoolTax);
      setLabelText('heating-fees', lang.heatingFees);
      setLabelText('interest-rate', lang.interestRate);
      setLabelText('mortgage-term', lang.mortgageTerm);
      setLabelText('amortization-period', lang.amortizationPeriod);
      if (step4Prev) step4Prev.textContent = lang.previous;
      
      const calculateButton = document.getElementById('calculate-button');
      if (calculateButton) calculateButton.textContent = lang.calculateButton;
      
      // Results
      setTextContent('qualification-summary-title', lang.results.qualificationSummary);
      setTextContent('payment-breakdown-title', lang.results.paymentBreakdown);
      setTextContent('recommendations-title', lang.results.recommendations);
      
      // Update mortgage details
      setTextContent('mortgage-amount-label', lang.results.mortgageDetails.amount);
      setTextContent('monthly-payment-label', lang.results.mortgageDetails.payment);
      setTextContent('payment-options-title', lang.results.mortgageDetails.frequency.title);
      setTextContent('monthly-option', lang.results.mortgageDetails.frequency.monthly);
      setTextContent('biweekly-option', lang.results.mortgageDetails.frequency.biweekly);
      setTextContent('weekly-option', lang.results.mortgageDetails.frequency.weekly);
      
      // Update tax labels
      setTextContent('property-tax-label', lang.results.taxes.property);
      setTextContent('school-tax-label', lang.results.taxes.school);
      setTextContent('monthly-tax-label', lang.results.taxes.monthly);
      
      // Update insurance labels
      setTextContent('cmhc-insurance-label', lang.results.insurance.cmhc);
      setTextContent('insurance-tax-label', lang.results.insurance.tax);
      setTextContent('total-insurance-label', lang.results.insurance.total);
      
      // Update ratio labels and modal
      setTextContent('gds-ratio-label', lang.results.ratios.gds);
      setTextContent('tds-ratio-label', lang.results.ratios.tds);
      setTextContent('view-ratio-details', lang.results.ratios.details);
      setTextContent('stress-test-label', lang.results.ratios.stress);
      
      // Update buttons
      if (recalculateButton) recalculateButton.textContent = lang.results.buttons.recalculate;
      if (saveScenarioButton) saveScenarioButton.textContent = lang.results.buttons.save;
      if (printResultsButton) printResultsButton.textContent = lang.results.buttons.print;
      if (clearScenariosButton) clearScenariosButton.textContent = lang.results.buttons.clear;
      
      // Update qualification status if exists
      const qualificationStatus = document.getElementById('qualification-status');
      if (qualificationStatus) {
        const status = qualificationStatus.getAttribute('data-status');
        if (status === 'approved') qualificationStatus.textContent = lang.results.qualification.approved;
        else if (status === 'conditions') qualificationStatus.textContent = lang.results.qualification.conditions;
        else if (status === 'denied') qualificationStatus.textContent = lang.results.qualification.denied;
      }
      
      // Update max amount section
      setTextContent('max-amount-label', lang.results.maxAmount.label);
      setTextContent('max-amount-note', lang.results.maxAmount.note);
      
      // Refresh the payment chart with new labels
      if (paymentChart) {
        createPaymentChart(
          paymentChart.data.datasets[0].data[0] + paymentChart.data.datasets[0].data[1],
          paymentChart.data.datasets[0].data[2],
          paymentChart.data.datasets[0].data[3],
          paymentChart.data.datasets[0].data[4],
          paymentChart.data.datasets[0].data[5]
        );
      }

      // Update BOC meeting details
      updateBOCMeeting();
    }
    
    // Theme toggle
    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      if (currentTheme === 'dark') {
        document.documentElement.removeAttribute('data-theme');
      } else {
        document.documentElement.setAttribute('data-theme', 'dark');
      }
    }
    
    // Step navigation with null checks
    function goToStep(step) {
      const stepContents = document.querySelectorAll('.step-content');
      const stepIndicators = document.querySelectorAll('.step');
      
      if (!stepContents.length || !stepIndicators.length) return;
      
      stepContents.forEach(function(content) {
        content.classList.remove('active');
      });
      
      const targetStep = document.getElementById('step-' + step);
      if (targetStep) targetStep.classList.add('active');
      
      stepIndicators.forEach(function(indicator) {
        if (!indicator) return;
        const stepNum = parseInt(indicator.getAttribute('data-step') || '0');
        indicator.classList.remove('active', 'completed');
        if (stepNum === step) {
          indicator.classList.add('active');
        } else if (stepNum < step) {
          indicator.classList.add('completed');
        }
      });

      updateProgress(step);
    }
    
    // Calculate minimum down payment with null checks
    function calculateMinDownPayment(price, propertyTypeValue) {
      if (!price || !propertyTypeValue) return 0;
      
      const isInvestmentProperty = ownerOccupiedToggle ? ownerOccupiedToggle.checked : false;
      
      // Investment properties require 20% down payment
      if (isInvestmentProperty) {
        return price * 0.2;
      }
      
      // 5+ unit properties are considered commercial and require 25% down payment
      if (propertyTypeValue === 'five-plus-units') {
        return price * 0.25; // Updated to 25% for 5+ unit properties
      }
      
      // Properties over $1M need 20% down payment (not eligible for CMHC insurance)
      if (price >= 1000000) {
        return price * 0.2;
      }
      
      // 2-4 unit properties (owner-occupied)
      if (['triplex', 'fourplex'].includes(propertyTypeValue)) {
        // Triplexes and fourplexes require 10% minimum
        return price * 0.1;
      }
      
      // Duplexes (owner-occupied)
      if (propertyTypeValue === 'duplex') {
        // Duplexes require 5% minimum
        if (price <= 500000) return price * 0.05;
        if (price <= 999999.99) return 25000 + (price - 500000) * 0.1;
        return price * 0.2; // Properties over $1M
      }
      
      // Single-family homes, condos, townhouses (owner-occupied)
      if (price <= 500000) return price * 0.05;
      if (price <= 999999.99) return 25000 + (price - 500000) * 0.1;
      return price * 0.2; // Properties over $1M
    }
    
    // Update minimum down payment notice with null checks
    function updateMinDownPaymentNotice() {
      if (!propertyPrice || !propertyType || !minDownPaymentNotice) return;
      
      const price = parseFloat(propertyPrice.value) || 0;
      const pType = propertyType.value;
      const minDP = calculateMinDownPayment(price, pType);
      
      const lang = translations[currentLanguage] || translations.en;
      minDownPaymentNotice.textContent = lang.minRequired + " $" + minDP.toLocaleString() + " (" + (minDP / price * 100 || 0).toFixed(1) + "%)";
    }
    
    // Update down payment slider with null checks
    function updateDownPaymentSlider() {
      if (!propertyPrice || !propertyType || !downPaymentSlider || !downPayment) return;
      
      const price = parseFloat(propertyPrice.value) || 0;
      const minDP = calculateMinDownPayment(price, propertyType.value);
      
      downPaymentSlider.min = minDP.toString();
      downPaymentSlider.max = price.toString();
      
      const currentDP = parseFloat(downPayment.value) || 0;
      if (currentDP < minDP) {
        downPayment.value = minDP.toString();
        downPaymentSlider.value = minDP.toString();
      } else if (currentDP > price) {
        downPayment.value = price.toString();
        downPaymentSlider.value = price.toString();
      }
    }
    
    // Validate down payment with null checks
    function validateDownPayment() {
      if (!propertyPrice || !propertyType || !downPayment || !downPaymentSlider) return;
      
      const price = parseFloat(propertyPrice.value) || 0;
      const dp = parseFloat(downPayment.value) || 0;
      const minDP = calculateMinDownPayment(price, propertyType.value);
      
      if (dp < minDP) {
        downPayment.value = minDP.toString();
        downPaymentSlider.value = minDP.toString();
      } else if (dp > price) {
        downPayment.value = price.toString();
        downPaymentSlider.value = price.toString();
      }
    }
    
    // Update credit card payment with null checks
    function updateCreditCardPayment() {
      if (!creditCardBalance || !creditCardPayment) return;
      
      const balance = parseFloat(creditCardBalance.value) || 0;
      const payment = balance * 0.03;
      const lang = translations[currentLanguage] || translations.en;
      creditCardPayment.textContent = lang.monthlyPayment + " $" + payment.toFixed(2);
    }
    
    // Update line of credit payment with null checks
    function updateLineOfCreditPayment() {
      if (!lineOfCreditBalance || !lineOfCreditPayment) return;
      
      const balance = parseFloat(lineOfCreditBalance.value) || 0;
      const payment = balance * 0.03;
      const lang = translations[currentLanguage] || translations.en;
      lineOfCreditPayment.textContent = lang.monthlyPayment + " $" + payment.toFixed(2);
    }
    
    // Update rental income notice
    function updateRentalIncomeNotice() {
      const rentalIncome = document.getElementById('expected-rental-income');
      const rentalIncomeNotice = document.querySelector('.rental-income-notice');
      if (rentalIncome && rentalIncomeNotice) {
        const income = parseFloat(rentalIncome.value) || 0;
        const qualifyingIncome = income * 0.8; // 80% of rental income
        const lang = translations[currentLanguage] || translations.en;
        rentalIncomeNotice.textContent = `${lang.qualifyingRentalIncome} $${qualifyingIncome.toFixed(2)}`;
      }
    }
    
    // Calculate total monthly income with null checks
    function calculateTotalMonthlyIncome() {
      let totalIncome = 0;
      
      // Regular income calculation
      const incomeAmount = document.getElementById('income-amount');
      const incomePeriod = document.getElementById('income-period');
      
      if (incomeAmount && incomePeriod) {
        const amount = parseFloat(incomeAmount.value) || 0;
        totalIncome += incomePeriod.value === 'annual' ? amount / 12 : amount;
      }
      
      // Co-applicant income calculation
      const includeCoApplicant = document.getElementById('include-co-applicant');
      if (includeCoApplicant && includeCoApplicant.value === 'yes') {
        const coApplicantIncome = document.getElementById('co-applicant-income');
        const coApplicantIncomePeriod = document.getElementById('co-applicant-income-period');
        
        if (coApplicantIncome && coApplicantIncomePeriod) {
          const coAmount = parseFloat(coApplicantIncome.value) || 0;
          totalIncome += coApplicantIncomePeriod.value === 'annual' ? coAmount / 12 : coAmount;
        }
      }
      
      // Rental income calculation
      const rentalIncomeInput = document.getElementById('expected-rental-income');
      if (rentalIncomeInput && rentalIncomeSection && rentalIncomeSection.style.display !== 'none') {
        const rentalIncome = parseFloat(rentalIncomeInput.value) || 0;
        // For rental properties, only 80% of rental income is considered
        const qualifyingRentalIncome = rentalIncome * 0.8;
        totalIncome += qualifyingRentalIncome;
      }
      
      return totalIncome;
    }
    
    // Calculate total monthly debts with null checks
    function calculateTotalMonthlyDebts() {
      let totalDebts = 0;
      
      const creditCardBalance = document.getElementById('credit-card-balance');
      if (creditCardBalance) {
        totalDebts += (parseFloat(creditCardBalance.value) || 0) * 0.03;
      }
      
      const lineOfCreditBalance = document.getElementById('line-of-credit-balance');
      if (lineOfCreditBalance) {
        totalDebts += (parseFloat(lineOfCreditBalance.value) || 0) * 0.03;
      }
      
      const carLoan = document.getElementById('car-loan');
      if (carLoan) {
        totalDebts += parseFloat(carLoan.value) || 0;
      }
      
      const studentLoan = document.getElementById('student-loan');
      if (studentLoan) {
        totalDebts += parseFloat(studentLoan.value) || 0;
      }
      
      const otherDebts = document.getElementById('other-debts');
      if (otherDebts) {
        totalDebts += parseFloat(otherDebts.value) || 0;
      }
      
      const condoFeesEl = document.getElementById('condo-fees');
      const municipalTaxEl = document.getElementById('municipal-tax');
      const schoolTaxEl = document.getElementById('school-tax');
      const heatingFeesEl = document.getElementById('heating-fees');
      
      const condoFees = condoFeesEl ? (parseFloat(condoFeesEl.value) || 0) : 0;
      const annualMunicipalTax = municipalTaxEl ? (parseFloat(municipalTaxEl.value) || 0) : 0;
      const annualSchoolTax = schoolTaxEl ? (parseFloat(schoolTaxEl.value) || 0) : 0;
      const heatingFees = heatingFeesEl ? (parseFloat(heatingFeesEl.value) || 0) : 0;
      
      const monthlyMunicipalTax = annualMunicipalTax / 12;
      const monthlySchoolTax = annualSchoolTax / 12;
      
      return totalDebts + monthlyMunicipalTax + monthlySchoolTax + heatingFees + condoFees;
    }
    
    // Calculate mortgage payment
    function calculateMortgagePayment(principal, interestRate, amortizationYears, frequency = 'monthly', isVariableRate = false) {
      if (!principal || !interestRate || !amortizationYears) return 0;

      let periodsPerYear;
      switch (frequency) {
        case 'weekly':
          periodsPerYear = 52;
          break;
        case 'biweekly':
          periodsPerYear = 26;
          break;
        default:
          periodsPerYear = 12;
      }

      let effectiveRate;
      if (isVariableRate) {
        // Simple periodic interest for variable rate
        effectiveRate = interestRate / 100 / periodsPerYear;
      } else {
        // Semi-annual compounding for fixed rate (Canadian standard)
        const semiAnnualRate = interestRate / 100 / 2;
        effectiveRate = Math.pow(1 + semiAnnualRate, 2/periodsPerYear) - 1;
      }

      const totalPeriods = amortizationYears * periodsPerYear;

      if (effectiveRate === 0) return principal / totalPeriods;

      return principal * (effectiveRate * Math.pow(1 + effectiveRate, totalPeriods)) / 
             (Math.pow(1 + effectiveRate, totalPeriods) - 1);
    }
    
    // Create payment chart with null checks
    function createPaymentChart(principalAndInterest, propertyTax, schoolTax, heating, condoFees) {
      const canvas = document.getElementById('payment-chart');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      if (!ctx) return;
      
      if (paymentChart) {
        paymentChart.destroy();
      }
      
      const principal = principalAndInterest * 0.6;
      const interest = principalAndInterest * 0.4;
      
      // Get translated chart labels based on current language
      const lang = translations[currentLanguage] || translations.en;
      const labels = [
        lang.results.chart.principal,
        lang.results.chart.interest,
        lang.results.chart.propertyTax,
        lang.results.chart.schoolTax,
        lang.results.chart.heating,
        lang.results.chart.condoFees
      ];
      
      // Check if dark mode is enabled for better chart visibility
      const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
      
      // Set colors for the chart based on theme
      const textColor = isDarkMode ? '#F0F0F5' : '#2C3E50';
      
      // Create colors array with higher contrast for dark mode
      const backgroundColors = isDarkMode ? 
        ['#FFD700', '#FFDF33', '#87CEEB', '#A7DEF5', '#5FAAC2', '#CCAC00'] :
        ['#FFA000', '#FFC107', '#2196F3', '#64B5F6', '#0D47A1', '#795548'];
      
      paymentChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: [principal, interest, propertyTax, schoolTax, heating, condoFees],
            backgroundColor: backgroundColors,
            borderWidth: isDarkMode ? 2 : 0,
            borderColor: isDarkMode ? '#1A1A1A' : '',
            hoverOffset: 15
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                color: textColor,
                font: {
                  size: 12,
                  weight: 'bold'
                },
                padding: 15
              }
            },
            tooltip: {
              backgroundColor: isDarkMode ? 'rgba(0, 0, 0, 0.8)' : 'rgba(255, 255, 255, 0.8)',
              titleColor: isDarkMode ? '#FFFFFF' : '#000000',
              bodyColor: isDarkMode ? '#FFFFFF' : '#000000',
              borderColor: isDarkMode ? '#333333' : '#DDDDDD',
              borderWidth: 1,
              callbacks: {
                label: function(tooltipItem) {
                  const value = tooltipItem.raw;
                  const total = tooltipItem.dataset.data.reduce(function(sum, val) { return sum + val; }, 0);
                  const percentage = (value / total * 100).toFixed(1);
                  return tooltipItem.label + ": $" + value.toFixed(2) + " (" + percentage + "%)";
                }
              }
            }
          }
        }
      });
    }
    
    // Calculate max mortgage from payment
    function calculateMaxMortgageFromPayment(maxPayment, interestRate, amortizationYears) {
      if (!maxPayment || !interestRate || !amortizationYears) return 0;
      
      const monthlyRate = interestRate / 100 / 12;
      const numberOfPayments = amortizationYears * 12;
      
      if (monthlyRate === 0) return maxPayment * numberOfPayments;
      
      return Math.round(maxPayment * (1 - Math.pow(1 + monthlyRate, -numberOfPayments)) / monthlyRate);
    }
    
    // Update payment amounts
    function updatePaymentAmounts(monthlyPayment) {
      const monthlyAmount = document.getElementById('monthly-amount');
      const biweeklyAmount = document.getElementById('biweekly-amount');
      const weeklyAmount = document.getElementById('weekly-amount');

      if (monthlyAmount && biweeklyAmount && weeklyAmount) {
        const monthly = monthlyPayment;
        const biweekly = (monthly * 12) / 26;
        const weekly = (monthly * 12) / 52;

        monthlyAmount.textContent = '$' + monthly.toFixed(2);
        biweeklyAmount.textContent = '$' + biweekly.toFixed(2);
        weeklyAmount.textContent = '$' + weekly.toFixed(2);
      }
    }
    
    // Generate recommendations with null checks
    function generateRecommendations(price, downPayment, ltv, mortgageAmount, cmhcPremium, gdsRatio, tdsRatio, gdsThreshold, tdsThreshold, monthlyIncome) {
      const recommendationsList = document.getElementById('recommendations-list');
      if (!recommendationsList) return;
      
      recommendationsList.innerHTML = '';
      
      // Calculate startup costs at 1.5% of property price
      const startupCosts = price * 0.015;
      
      // Calculate tax on CMHC premium (Quebec taxes GST 5% + QST 9.975% = ~15%)
      const cmhcTaxRate = 0.15;
      const cmhcTaxAmount = cmhcPremium * cmhcTaxRate;
      const cmhcWithTax = cmhcPremium + cmhcTaxAmount;
      
      // Tax on CMHC premium must be paid upfront and cannot be financed
      const totalUpfrontNeeded = downPayment + startupCosts + (ltv > 80 ? cmhcTaxAmount : 0);
      
      // Get language-specific recommendation texts
      const lang = currentLanguage;
      const annualIncome = monthlyIncome * 12;
      const priceToIncomeRatio = price / annualIncome;
      const isInvestmentProperty = ownerOccupiedToggle ? ownerOccupiedToggle.checked : false;
      
      // Property-specific recommendations
      const propertyTypeValue = propertyType ? propertyType.value : 'single-family';
      const is5PlusProperty = propertyTypeValue === 'five-plus-units';
      
      // Create recommendation objects for each language
      const recommendations = {
        en: [
          `<strong>Upfront costs:</strong> In addition to your $${downPayment.toLocaleString()} down payment, budget approximately $${startupCosts.toLocaleString()} (1.5% of property value) for closing costs.${ltv > 80 ? ` Plus an additional $${cmhcTaxAmount.toLocaleString()} for taxes on CMHC premium that cannot be financed.` : ""} Total funds needed: $${totalUpfrontNeeded.toLocaleString()}.`,
          
          ltv > 80 && price < 1000000 && !isInvestmentProperty && !is5PlusProperty ? 
            `<strong>CMHC insurance:</strong> Consider increasing your down payment to at least 20% ($${(price * 0.2).toLocaleString()}) to avoid CMHC insurance premium of $${cmhcPremium.toLocaleString()} plus $${cmhcTaxAmount.toLocaleString()} in taxes.` : "",
          
          gdsRatio > gdsThreshold ? 
            `<strong>GDS ratio:</strong> Your GDS ratio (${gdsRatio.toFixed(1)}%) exceeds the ${gdsThreshold}% threshold. Consider a larger down payment or a more affordable property.` : "",
          
          tdsRatio > tdsThreshold ? 
            `<strong>TDS ratio:</strong> Your TDS ratio (${tdsRatio.toFixed(1)}%) exceeds the ${tdsThreshold}% threshold. Consider reducing other debts before applying.` : "",
          
          priceToIncomeRatio > 5 ? 
            `<strong>Income ratio:</strong> Property price is ${priceToIncomeRatio.toFixed(1)}x your annual income, which is high. Financial experts recommend a target of 3-4x annual income.` : "",
          
          price > 1000000 ? 
            `<strong>High-value property:</strong> For properties over $1,000,000, a minimum 20% down payment is required and CMHC insurance is not available.` : "",
          
          isInvestmentProperty ? 
            `<strong>Investment property:</strong> Investment properties require a minimum 20% down payment and are not eligible for CMHC insurance.` : ""
        ],
        
        fr: [
          `<strong>Frais initiaux:</strong> En plus de votre mise de fonds de $${downPayment.toLocaleString()}, prévoyez environ $${startupCosts.toLocaleString()} (1,5% de la valeur de la propriété) pour les frais de clôture.${ltv > 80 ? ` Plus $${cmhcTaxAmount.toLocaleString()} additionnels pour les taxes sur la prime SCHL qui ne peuvent pas être financées.` : ""} Total des fonds nécessaires: $${totalUpfrontNeeded.toLocaleString()}.`,
          
          ltv > 80 && price < 1000000 && !isInvestmentProperty && !is5PlusProperty ? 
            `<strong>Assurance SCHL:</strong> Envisagez d'augmenter votre mise de fonds à au moins 20% ($${(price * 0.2).toLocaleString()}) pour éviter la prime d'assurance SCHL de $${cmhcPremium.toLocaleString()} plus $${cmhcTaxAmount.toLocaleString()} en taxes.` : "",
          
          gdsRatio > gdsThreshold ? 
            `<strong>Ratio ABD:</strong> Votre ratio ABD (${gdsRatio.toFixed(1)}%) dépasse le seuil de ${gdsThreshold}%. Envisagez une mise de fonds plus importante ou une propriété plus abordable.` : "",
          
          tdsRatio > tdsThreshold ? 
            `<strong>Ratio ATD:</strong> Votre ratio ATD (${tdsRatio.toFixed(1)}%) dépasse le seuil de ${tdsThreshold}%. Envisagez de réduire vos autres dettes avant de faire une demande.` : "",
          
          priceToIncomeRatio > 5 ? 
            `<strong>Ratio revenu:</strong> Le prix de la propriété représente ${priceToIncomeRatio.toFixed(1)}x votre revenu annuel, ce qui est élevé. Les experts financiers recommandent un objectif de 3-4x le revenu annuel.` : "",
          
          price > 1000000 ? 
            `<strong>Propriété de grande valeur:</strong> Pour les propriétés de plus de 1 000 000$, une mise de fonds minimale de 20% est requise et l'assurance SCHL n'est pas disponible.` : "",
          
          isInvestmentProperty ? 
            `<strong>Propriété d'investissement:</strong> Les propriétés d'investissement nécessitent une mise de fonds minimale de 20% et ne sont pas admissibles à l'assurance SCHL.` : ""
        ],
        
        es: [
          `<strong>Costos iniciales:</strong> Además de su pago inicial de $${downPayment.toLocaleString()}, presupueste aproximadamente $${startupCosts.toLocaleString()} (1,5% del valor de la propiedad) para gastos de cierre.${ltv > 80 ? ` Más $${cmhcTaxAmount.toLocaleString()} adicionales por impuestos sobre la prima de CMHC que no pueden financiarse.` : ""} Fondos totales necesarios: $${totalUpfrontNeeded.toLocaleString()}.`,
          
          ltv > 80 && price < 1000000 && !isInvestmentProperty && !is5PlusProperty ? 
            `<strong>Seguro CMHC:</strong> Considere aumentar su pago inicial a al menos 20% ($${(price * 0.2).toLocaleString()}) para evitar la prima de seguro CMHC de $${cmhcPremium.toLocaleString()} más $${cmhcTaxAmount.toLocaleString()} en impuestos.` : "",
          
          gdsRatio > gdsThreshold ? 
            `<strong>Ratio GDS:</strong> Su ratio GDS (${gdsRatio.toFixed(1)}%) excede el umbral de ${gdsThreshold}%. Considere un pago inicial mayor o una propiedad más asequible.` : "",
          
          tdsRatio > tdsThreshold ? 
            `<strong>Ratio TDS:</strong> Su ratio TDS (${tdsRatio.toFixed(1)}%) excede el umbral de ${tdsThreshold}%. Considere reducir otras deudas antes de solicitar.` : "",
          
          priceToIncomeRatio > 5 ? 
            `<strong>Ratio de ingresos:</strong> El precio de la propiedad es ${priceToIncomeRatio.toFixed(1)}x su ingreso anual, lo cual es alto. Los expertos financieros recomiendan un objetivo de 3-4x el ingreso anual.` : "",
          
          price > 1000000 ? 
            `<strong>Propiedad de alto valor:</strong> Para propiedades de más de $1,000,000, se requiere un pago inicial mínimo del 20% y el seguro CMHC no está disponible.` : "",
          
          isInvestmentProperty ? 
            `<strong>Propiedad de inversión:</strong> Las propiedades de inversión requieren un pago inicial mínimo del 20% y no son elegibles para el seguro CMHC.` : ""
        ],
        
        ru: [
          `<strong>Первоначальные расходы:</strong> Помимо вашего первоначального взноса в $${downPayment.toLocaleString()}, рассчитывайте примерно на $${startupCosts.toLocaleString()} (1,5% от стоимости недвижимости) для расходов на закрытие сделки.${ltv > 80 ? ` Плюс дополнительно $${cmhcTaxAmount.toLocaleString()} на налоги на страховую премию CMHC, которые нельзя финансировать.` : ""} Всего необходимо: $${totalUpfrontNeeded.toLocaleString()}.`,
          
          ltv > 80 && price < 1000000 && !isInvestmentProperty && !is5PlusProperty ? 
            `<strong>Страхование CMHC:</strong> Рассмотрите возможность увеличения первоначального взноса до не менее 20% ($${(price * 0.2).toLocaleString()}), чтобы избежать страховой премии CMHC в размере $${cmhcPremium.toLocaleString()} плюс $${cmhcTaxAmount.toLocaleString()} в виде налогов.` : "",
          
          gdsRatio > gdsThreshold ? 
            `<strong>Коэффициент GDS:</strong> Ваш коэффициент GDS (${gdsRatio.toFixed(1)}%) превышает порог в ${gdsThreshold}%. Рассмотрите возможность увеличения первоначального взноса или выбора более доступной недвижимости.` : "",
          
          tdsRatio > tdsThreshold ? 
            `<strong>Коэффициент TDS:</strong> Ваш коэффициент TDS (${tdsRatio.toFixed(1)}%) превышает порог в ${tdsThreshold}%. Рассмотрите возможность снижения других долгов перед подачей заявки.` : "",
          
          priceToIncomeRatio > 5 ? 
            `<strong>Соотношение с доходом:</strong> Цена недвижимости в ${priceToIncomeRatio.toFixed(1)} раз превышает ваш годовой доход, что является высоким показателем. Финансовые эксперты рекомендуют целевое соотношение 3-4 раза годового дохода.` : "",
          
          price > 1000000 ? 
            `<strong>Недвижимость высокой стоимости:</strong> Для недвижимости стоимостью более $1,000,000 требуется минимальный первоначальный взнос в 20%, а страхование CMHC недоступно.` : "",
          
          isInvestmentProperty ? 
            `<strong>Инвестиционная недвижимость:</strong> Инвестиционная недвижимость требует минимального первоначального взноса в 20% и не подлежит страхованию CMHC.` : ""
        ]
      };
      
      // Filter out empty recommendations and limit to 7 items
      const currentLangRecs = recommendations[lang] || recommendations.en;
      const filteredRecs = currentLangRecs.filter(rec => rec !== "").slice(0, 7);
      
      // Create ul element for bullet points
      const ul = document.createElement('ul');
      ul.className = 'recommendation-list';
      
      // Add CSS for bullet points
      const style = document.createElement('style');
      style.textContent = `
        .recommendation-list {
          list-style-type: none;
          padding-left: 0;
        }
        .recommendation-list li {
          position: relative;
          margin-bottom: 1rem;
          padding-left: 1.5rem;
          padding-bottom: 0.75rem;
          border-bottom: 1px solid var(--border-color);
        }
        .recommendation-list li:last-child {
          border-bottom: none;
        }
        .recommendation-list li::before {
          content: "•";
          position: absolute;
          left: 0;
          color: var(--primary-color);
          font-weight: bold;
          font-size: 1.2rem;
        }
      `;
      document.head.appendChild(style);
      
      // Add each recommendation as a list item
      filteredRecs.forEach(rec => {
        const li = document.createElement('li');
        li.innerHTML = rec; // Using innerHTML to render the HTML tags
        ul.appendChild(li);
      });
      
      recommendationsList.appendChild(ul);
      
      // Add seasonal context to recommendations if we have room (still under 7)
      if (filteredRecs.length < 7) {
        const currentMonth = new Date().toLocaleString('en-US', { month: 'long' }).toLowerCase();
        const campaign = getSeasonalCampaign(currentMonth);
        
        if (campaign) {
          const seasonalLi = document.createElement('li');
          seasonalLi.className = 'campaign-feature';
          seasonalLi.innerHTML = `<strong>Seasonal tip:</strong> ${campaign.tip}`;
          ul.appendChild(seasonalLi);
        }
      }
    }
    
    // Calculate CMHC insurance premium based on loan-to-value ratio
    function calculateCMHCPremium(mortgageAmount, propertyPrice) {
      const ltv = (mortgageAmount / propertyPrice) * 100;
      
      let premiumRate = 0;
      
      if (ltv <= 65) {
        premiumRate = 0.006;
      } else if (ltv > 65 && ltv <= 75) {
        premiumRate = 0.017;
      } else if (ltv > 75 && ltv <= 80) {
        premiumRate = 0.024;
      } else if (ltv > 80 && ltv <= 85) {
        premiumRate = 0.028;
      } else if (ltv > 85 && ltv <= 90) {
        premiumRate = 0.031;
      } else if (ltv > 90 && ltv <= 95) {
        premiumRate = 0.04;
      }
      
      return Math.round(mortgageAmount * premiumRate);
    }
    
    // Main calculation function with null checks
    function calculateMortgage() {
      // Make sure required elements exist
      if (!resultsContainer || !formContainer) return;
      
      // Create a loading spinner
      const spinner = document.createElement('div');
      spinner.className = 'spinner';
      resultsContainer.appendChild(spinner);
      
      // Use setTimeout to allow the browser to render the spinner
      setTimeout(function() {
        try {
          // Get form values with null checks
          const propertyPriceEl = document.getElementById('property-price');
          const downPaymentEl = document.getElementById('down-payment');
          const interestRateEl = document.getElementById('interest-rate');
          const amortizationPeriodEl = document.getElementById('amortization-period');
          const propertyLocationEl = document.getElementById('property-location');
          const mortgageProductEl = document.getElementById('mortgage-product');
          
          // Validate required fields
          if (!propertyPriceEl?.value || !downPaymentEl?.value || !interestRateEl?.value) {
            alert('Please fill in all required fields');
            spinner.remove();
            return;
          }
          
          const price = parseFloat(propertyPriceEl.value) || 0;
          const dp = parseFloat(downPaymentEl.value) || 0;
          const interestRateValue = parseFloat(interestRateEl.value) || 0;
          const amortizationPeriod = parseInt(amortizationPeriodEl?.value) || 25;
          const propertyLocation = propertyLocationEl?.value || 'montreal';
          const mortgageProduct = mortgageProductEl?.value || 'fixed';
          
          // Get expense values
          const condoFees = parseFloat(document.getElementById('condo-fees')?.value) || 0;
          const municipalTax = parseFloat(document.getElementById('municipal-tax')?.value) || 0;
          const schoolTax = parseFloat(document.getElementById('school-tax')?.value) || 0;
          const heatingFees = parseFloat(document.getElementById('heating-fees')?.value) || 0;
          
          // Calculate basic mortgage details
          const mortgageAmount = price - dp;
          const ltv = (mortgageAmount / price) * 100;
          
          // Calculate monthly expenses
          const monthlyMunicipalTax = municipalTax / 12;
          const monthlySchoolTax = schoolTax / 12;
          
          // Calculate monthly payment
          const monthlyPayment = calculateMortgagePayment(mortgageAmount, interestRateValue, amortizationPeriod);
          
          // Calculate GDS and TDS ratios
          const monthlyIncome = calculateTotalMonthlyIncome();
          const monthlyDebts = calculateTotalMonthlyDebts();
          const totalHousingCosts = monthlyPayment + condoFees + monthlyMunicipalTax + monthlySchoolTax + heatingFees;
          
          const gdsRatio = (totalHousingCosts / monthlyIncome) * 100;
          const tdsRatio = ((totalHousingCosts + monthlyDebts) / monthlyIncome) * 100;
          
          // Show results
          displayResults({
            price,
            downPayment: dp,
            mortgageAmount,
            monthlyPayment,
            gdsRatio,
            tdsRatio,
            totalHousingCosts,
            monthlyDebts,
            monthlyIncome
          });
          
          // Show results container
          formContainer.classList.remove('active');
          resultsContainer.classList.add('active');
          
        } catch (error) {
          console.error('Calculation error:', error);
          alert('There was an error calculating your mortgage. Please check your inputs.');
        } finally {
          spinner.remove();
        }
      }, 500);
    }
    
    // Add a new helper function to display results
    function displayResults(data) {
      // Update qualification status
      const qualificationStatus = document.getElementById('qualification-status');
      let statusClass = '';
      let statusText = '';
      
      if (data.gdsRatio <= 32 && data.tdsRatio <= 40) {
        statusClass = 'approved';
        statusText = 'Approved';
      } else if (data.gdsRatio <= 35 && data.tdsRatio <= 42) {
        statusClass = 'warning';
        statusText = 'Approved with Conditions';
      } else {
        statusClass = 'denied';
        statusText = 'Not Qualified';
      }
      
      if (qualificationStatus) {
        qualificationStatus.className = `qualification-status ${statusClass}`;
        qualificationStatus.textContent = statusText;
      }
      
      // Update other result elements
      setTextContent('mortgage-amount', `$${data.mortgageAmount.toLocaleString()}`);
      setTextContent('monthly-payment', `$${data.monthlyPayment.toFixed(2)}`);
      setTextContent('gds-ratio', `${data.gdsRatio.toFixed(1)}%`);
      setTextContent('tds-ratio', `${data.tdsRatio.toFixed(1)}%`);
      
      // Update payment breakdown chart
      createPaymentChart(
        data.monthlyPayment,
        data.totalHousingCosts - data.monthlyPayment,
        data.monthlyDebts,
        0,
        0
      );
      
      // Generate recommendations
      generateRecommendations(
        data.price,
        data.downPayment,
        (data.mortgageAmount / data.price) * 100,
        data.mortgageAmount,
        0,
        data.gdsRatio,
        data.tdsRatio,
        32,
        40,
        data.monthlyIncome
      );
    }
    
    // Update the event listener setup
    document.addEventListener('DOMContentLoaded', function() {
      // ...existing code...
      
      // Add calculate button listener
      const calculateButton = document.getElementById('step-4-next');
      if (calculateButton) {
        calculateButton.addEventListener('click', function(e) {
          e.preventDefault();
          // Use the fixed calculation function 
          fixMortgageCalculation();
          calculateMortgage();
        });
      }
      
      // ...existing code...
    });
    
    // Save scenario with null checks
    function saveScenario() {
      const propertyPriceEl = document.getElementById('property-price');
      const downPaymentEl = document.getElementById('down-payment');
      const interestRateEl = document.getElementById('interest-rate');
      const monthlyPaymentEl = document.getElementById('monthly-payment');
      const qualificationStatusEl = document.getElementById('qualification-status');
      const maxQualifyingAmountEl = document.getElementById('max-qualification-amount');
      
      if (!propertyPriceEl || !downPaymentEl || !interestRateEl || 
          !monthlyPaymentEl || !qualificationStatusEl || !maxQualifyingAmountEl) {
        console.error('Missing required elements for saving scenario');
        return;
      }
      
      const scenario = {
        propertyPrice: parseFloat(propertyPriceEl.value) || 0,
        downPayment: parseFloat(downPaymentEl.value) || 0,
        interestRate: parseFloat(interestRateEl.value) || 0,
        monthlyPayment: parseFloat(monthlyPaymentEl.textContent.replace('$', '').replace(',', '')) || 0,
        qualificationStatus: qualificationStatusEl.textContent,
        maxQualifyingAmount: parseFloat(maxQualifyingAmountEl.textContent.replace('$', '').replace(',', '')) || 0
      };
      
      scenarios.push(scenario);
      updateComparisonTable();
    }
    
    // Update comparison table with null checks
    function updateComparisonTable() {
      const comparisonContainer = document.getElementById('comparison-container');
      const comparisonTable = document.getElementById('comparison-table');
      
      if (!comparisonContainer || !comparisonTable) return;
      
      if (scenarios.length > 0) {
        comparisonContainer.style.display = 'block';
        let tableHTML = '<table style="width: 100%; border-collapse: collapse;">';
        tableHTML += '<thead><tr style="background-color: var(--primary-color); color: white;">';
        tableHTML += '<th style="padding: 10px; text-align: left;">Property Price</th>';
        tableHTML += '<th style="padding: 10px; text-align: left;">Down Payment</th>';
        tableHTML += '<th style="padding: 10px; text-align: left;">Interest Rate</th>';
        tableHTML += '<th style="padding: 10px; text-align: left;">Monthly Payment</th>';
        tableHTML += '<th style="padding: 10px; text-align: left;">Max Qualifying Amount</th>';
        tableHTML += '<th style="padding: 10px; text-align: left;">Status</th>';
        tableHTML += '</tr></thead><tbody>';
        
        scenarios.forEach(function(s) {
          tableHTML += '<tr style="border-bottom: 1px solid var(--border-color);">';
          tableHTML += '<td style="padding: 10px;">$' + s.propertyPrice.toLocaleString() + '</td>';
          tableHTML += '<td style="padding: 10px;">$' + s.downPayment.toLocaleString() + '</td>';
          tableHTML += '<td style="padding: 10px;">' + s.interestRate.toFixed(2) + '%</td>';
          tableHTML += '<td style="padding: 10px;">$' + s.monthlyPayment.toLocaleString() + '</td>';
          tableHTML += '<td style="padding: 10px;">$' + s.maxQualifyingAmount.toLocaleString() + '</td>';
          
          let statusClass = '';
          const lang = translations[currentLanguage] || translations.en;
          
          if (s.qualificationStatus === lang.results.qualification.approved) {
            statusClass = 'color: var(--success-color);';
          } else if (s.qualificationStatus === lang.results.qualification.conditions) {
            statusClass = 'color: var(--warning-color);';
          } else if (s.qualificationStatus === lang.results.qualification.denied) {
            statusClass = 'color: var(--danger-color);';
          }
          
          tableHTML += '<td style="padding: 10px; ' + statusClass + '">' + s.qualificationStatus + '</td>';
          tableHTML += '</tr>';
        });
        
        tableHTML += '</tbody></table>';
        comparisonTable.innerHTML = tableHTML;
      } else {
        comparisonContainer.style.display = 'none';
      }
    }
    
    // Clear scenarios
    function clearScenarios() {
      scenarios = [];
      updateComparisonTable();
    }
    
    // Enhance step navigation
    function enhanceStepNavigation() {
      const steps = document.querySelectorAll('.step');
      steps.forEach(step => {
        step.addEventListener('click', () => {
          const stepNumber = parseInt(step.getAttribute('data-step'));
          goToStep(stepNumber);
        });
      });
    }
    
    // Enhance results visualization
    function enhanceResultsVisualization() {
      return function() {
        const qualificationStatusEl = document.getElementById('qualification-status');
        if (qualificationStatusEl) {
          qualificationStatusEl.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
          qualificationStatusEl.style.transform = 'scale(1.1)';
          qualificationStatusEl.style.opacity = '0.9';
          setTimeout(() => {
            qualificationStatusEl.style.transform = 'scale(1)';
            qualificationStatusEl.style.opacity = '1';
          }, 300);
        }
      };
    }
    
    // Global variable for storing preferences during the current session
    let currentPreferences = null;
    
    // Initialize personalization - removed

    // Seasonal campaign management
    // Complete translations for all months and all languages
    const seasonalCampaigns = {
      january: {
        quote: "❄️ Buying in Montreal: The only place where your radiator costs more than your mortgage!",
        author: "- Hydro-Québec's Favorite Customer",
        tip: "Consider energy efficiency upgrades to reduce winter heating costs."
      },
      february: {
        quote: "🏠 Your first home or another winter at mom's? Choose quickly, the temperature is rising... in the basement!",
        author: "- Laval's Biggest Mama's Boy",
        tip: "February is a good time to get pre-approved before the spring market rush."
      },
      march: {
        quote: "🍁 Maple syrup or mortgage payment? This year, both will put you in the red!",
        author: "- The Sweet & Salty Quebecker",
        tip: "Spring market is heating up. Lock in your rate now before potential increases."
      },
      april: {
        quote: "🚧 Orange cone season: The only place in the world where your GPS says 'Recalculating' every 30 seconds!",
        author: "- 4x4 Owner for Pothole Survival",
        tip: "Consider properties with good sound insulation during construction season."
      },
      may: {
        quote: "🏎️ Montreal Grand Prix: When renting a parking spot costs more than your first apartment!",
        author: "- Exiled Resident of Notre-Dame Island",
        tip: "Properties near public transit often have better long-term appreciation."
      },
      june: {
        quote: "🎮 Video game degree? Congratulations! You can now afford half a closet in Hochelaga!",
        author: "- Ubisoft's Rentless Ex-Intern",
        tip: "Consider emerging neighborhoods for better value and growth potential."
      },
      july: {
        quote: "📦 July 1st: The only day when everyone moves, but nobody knows why!",
        author: "- Professional Beer-Fueled Mover",
        tip: "July 1st is moving day - plan well ahead if buying or selling near this date."
      },
      august: {
        quote: "☕ Living in Rosemont: 'No, no, I was here BEFORE the $7 coffees and $1000 strollers!'",
        author: "- Terminal Phase Hipster",
        tip: "Summer slowdown can mean better deals and less competition for buyers."
      },
      september: {
        quote: "📚 The students are back! Time to transform your tiny apartment into a coliving space for 8!",
        author: "- Opportunistic Millennial Landlord",
        tip: "Investment properties near universities typically have strong rental demand."
      },
      october: {
        quote: "👻 Halloween: The only time when real estate prices are scarier than the decorations!",
        author: "- Real Estate Agent Disguised as Banker",
        tip: "Fall is a good time to negotiate - sellers may be motivated before winter."
      },
      november: {
        quote: "🏒 Buy when the Canadiens are losing (now), sell when they win (never)!",
        author: "- Habs Fan with an Underwater Mortgage",
        tip: "Consider winter home inspection to spot heating issues and insulation problems."
      },
      december: {
        quote: "🥯 Montreal: Where the bagels are better than New York's, but so are the rents!",
        author: "- Fairmount vs St-Viateur vs Your Bank Account",
        tip: "Year-end can bring motivated sellers and potential deals before the new year."
      },
      // French translations - complete for all months
      fr: {
        january: {
          quote: "❄️ Acheter à Montréal: Le seul endroit où ton radiateur coûte plus cher que ton hypothèque!",
          author: "- Le Meilleur Client d'Hydro-Québec",
          tip: "Envisagez des améliorations d'efficacité énergétique pour réduire les coûts de chauffage hivernal."
        },
        february: {
          quote: "🏠 Ta première maison ou un autre hiver chez maman? Choisis vite, la température monte... dans le sous-sol!",
          author: "- Le Fils à Maman de Laval",
          tip: "Février est un bon moment pour obtenir une préapprobation avant la ruée du marché printanier."
        },
        march: {
          quote: "🍁 Sirop d'érable ou versement hypothécaire? Cette année, les deux vont te mettre dans le rouge!",
          author: "- Le Québécois Sucré-Salé",
          tip: "Le marché du printemps s'échauffe. Fixez votre taux maintenant avant les augmentations potentielles."
        },
        april: {
          quote: "🚧 Saison des cônes orange: Le seul endroit au monde où ton GPS dit 'Recalcul' toutes les 30 secondes!",
          author: "- Propriétaire d'un 4x4 Pour Nids-de-Poule",
          tip: "Considérez les propriétés avec une bonne isolation phonique pendant la saison de construction."
        },
        may: {
          quote: "🏎️ Grand Prix de Montréal: Quand louer un stationnement coûte plus cher que ton premier appartement!",
          author: "- Habitant Exilé de l'Île Notre-Dame",
          tip: "Les propriétés près des transports en commun ont souvent une meilleure appréciation à long terme."
        },
        june: {
          quote: "🎮 Diplômé en jeux vidéo? Félicitations! Tu peux maintenant t'offrir un demi-placard à Hochelaga!",
          author: "- Ex-Stagiaire d'Ubisoft Sans Loyer",
          tip: "Considérez les quartiers émergents pour une meilleure valeur et un potentiel de croissance."
        },
        july: {
          quote: "📦 1er juillet: Le seul jour où tout le monde déménage, mais personne ne sait pourquoi!",
          author: "- Professionnel du Déménagement à la Bière",
          tip: "Le 1er juillet est le jour du déménagement - planifiez bien à l'avance si vous achetez ou vendez près de cette date."
        },
        august: {
          quote: "☕ Habiter à Rosemont: 'Non, non, j'étais là AVANT les cafés à 7$ et les poussettes à 1000$!'",
          author: "- Hipster en Phase Terminale",
          tip: "Le ralentissement estival peut signifier de meilleures offres et moins de concurrence pour les acheteurs."
        },
        september: {
          quote: "📚 Les étudiants reviennent! Temps de transformer ton 3½ en collocation pour 8 personnes!",
          author: "- Propriétaire Millénial Opportuniste",
          tip: "Les propriétés d'investissement près des universités ont généralement une forte demande locative."
        },
        october: {
          quote: "👻 Halloween: Le seul moment où les prix de l'immobilier font plus peur que les décorations!",
          author: "- Agent Immobilier Déguisé en Banquier",
          tip: "L'automne est un bon moment pour négocier - les vendeurs peuvent être motivés avant l'hiver."
        },
        november: {
          quote: "🏒 Achète quand les Canadiens perdent (maintenant), vends quand ils gagnent (jamais)!",
          author: "- Fan du CH avec un Prêt Sous-marin",
          tip: "Envisagez une inspection hivernale pour repérer les problèmes de chauffage et d'isolation."
        },
        december: {
          quote: "🥯 Montréal: Où les bagels sont meilleurs que ceux de New York, mais les loyers aussi!",
          author: "- Fairmount vs St-Viateur vs Ton Compte en Banque",
          tip: "La fin d'année peut apporter des vendeurs motivés et des opportunités avant la nouvelle année."
        }
      },
      // Spanish translations - complete for all months
      es: {
        january: {
          quote: "❄️ Comprar en Montreal: ¡El único lugar donde tu radiador cuesta más que tu hipoteca!",
          author: "- El Cliente Favorito de Hydro-Québec",
          tip: "Considere mejoras de eficiencia energética para reducir los costos de calefacción en invierno."
        },
        february: {
          quote: "🏠 ¿Tu primera casa o un invierno más en casa de mamá? ¡Elige rápido, la temperatura está subiendo... en el sótano!",
          author: "- El Niño Consentido de Laval",
          tip: "Febrero es un buen momento para obtener una preaprobación antes de la prisa del mercado primaveral."
        },
        march: {
          quote: "🍁 ¿Jarabe de arce o pago hipotecario? ¡Este año, ambos te dejarán en números rojos!",
          author: "- El Quebequense Agridulce",
          tip: "El mercado de primavera se está calentando. Asegure su tasa ahora antes de posibles aumentos."
        },
        april: {
          quote: "🚧 Temporada de conos naranjas: ¡El único lugar en el mundo donde tu GPS dice 'Recalculando' cada 30 segundos!",
          author: "- Propietario de 4x4 para Baches",
          tip: "Considere propiedades con buen aislamiento acústico durante la temporada de construcción."
        },
        may: {
          quote: "🏎️ Gran Premio de Montreal: ¡Cuando alquilar un estacionamiento cuesta más que tu primer apartamento!",
          author: "- Residente Exiliado de la Isla Notre-Dame",
          tip: "Las propiedades cerca del transporte público suelen tener mejor apreciación a largo plazo."
        },
        june: {
          quote: "🎮 ¿Título en videojuegos? ¡Felicidades! ¡Ahora puedes permitirte medio armario en Hochelaga!",
          author: "- Ex-Becario sin Alquiler de Ubisoft",
          tip: "Considere barrios emergentes para mejor valor y potencial de crecimiento."
        },
        july: {
          quote: "📦 1 de julio: ¡El único día en que todos se mudan, pero nadie sabe por qué!",
          author: "- Profesional de Mudanza a Base de Cerveza",
          tip: "El 1 de julio es día de mudanza - planifique bien si compra o vende cerca de esta fecha."
        },
        august: {
          quote: "☕ Vivir en Rosemont: '¡No, no, yo estaba aquí ANTES de los cafés de $7 y los cochecitos de $1000!'",
          author: "- Hipster en Fase Terminal",
          tip: "La desaceleración del verano puede significar mejores ofertas y menos competencia."
        },
        september: {
          quote: "📚 ¡Los estudiantes están de vuelta! ¡Hora de transformar tu mini apartamento en una coliving para 8!",
          author: "- Propietario Milenial Oportunista",
          tip: "Las propiedades de inversión cerca de universidades suelen tener fuerte demanda de alquiler."
        },
        october: {
          quote: "👻 Halloween: ¡El único momento en que los precios inmobiliarios dan más miedo que las decoraciones!",
          author: "- Agente Inmobiliario Disfrazado de Banquero",
          tip: "El otoño es buen momento para negociar - los vendedores pueden estar motivados antes del invierno."
        },
        november: {
          quote: "🏒 ¡Compra cuando los Canadiens estén perdiendo (ahora), vende cuando ganen (nunca)!",
          author: "- Fan de los Habs con Hipoteca Bajo Agua",
          tip: "Considere inspección invernal para detectar problemas de calefacción y aislamiento."
        },
        december: {
          quote: "🥯 Montreal: ¡Donde los bagels son mejores que los de Nueva York, pero también los alquileres!",
          author: "- Fairmount vs St-Viateur vs Tu Cuenta Bancaria",
          tip: "El fin de año puede traer vendedores motivados y potenciales ofertas antes del año nuevo."
        }
      },
      // Russian translations - complete for all months
      ru: {
        january: {
          quote: "❄️ Покупка в Монреале: единственное место, где радиатор стоит дороже, чем ипотека!",
          author: "- Любимый клиент Hydro-Québec",
          tip: "Рассмотрите возможность повышения энергоэффективности для снижения затрат на отопление."
        },
        february: {
          quote: "🏠 Первый дом или еще одна зима у мамы? Выбирай быстрее, температура растет... в подвале!",
          author: "- Главный Маменькин Сынок Лаваля",
          tip: "Февраль - хорошее время для предварительного одобрения перед весенним ажиотажем."
        },
        march: {
          quote: "🍁 Кленовый сироп или ипотечный платеж? В этом году оба загонят тебя в минус!",
          author: "- Квебекец с Кисло-Сладким Вкусом",
          tip: "Весенний рынок набирает обороты. Зафиксируйте ставку сейчас, до возможного повышения."
        },
        april: {
          quote: "🚧 Сезон оранжевых конусов: единственное место, где GPS говорит 'Пересчет маршрута' каждые 30 секунд!",
          author: "- Владелец 4х4 для Выживания в Ямах",
          tip: "Рассмотрите недвижимость с хорошей звукоизоляцией в сезон строительства."
        },
        may: {
          quote: "🏎️ Гран-при Монреаля: когда аренда парковки стоит дороже твоей первой квартиры!",
          author: "- Изгнанник с Острова Нотр-Дам",
          tip: "Недвижимость рядом с общественным транспортом часто лучше растет в цене."
        },
        june: {
          quote: "🎮 Диплом по видеоиграм? Поздравляем! Теперь ты можешь позволить себе половину шкафа в Хочелаге!",
          author: "- Бывший Стажёр Ubisoft без Аренды",
          tip: "Рассмотрите развивающиеся районы для лучшей ценности и потенциала роста."
        },
        july: {
          quote: "📦 1 июля: единственный день, когда все переезжают, но никто не знает почему!",
          author: "- Профессионал по Переездам на Пиве",
          tip: "1 июля - день переезда. Планируйте заранее покупку или продажу близко к этой дате."
        },
        august: {
          quote: "☕ Жизнь в Розмонте: 'Нет-нет, я был здесь ДО кофе за $7 и колясок за $1000!'",
          author: "- Хипстер в Терминальной Стадии",
          tip: "Летнее затишье может означать лучшие предложения и меньшую конкуренцию."
        },
        september: {
          quote: "📚 Студенты вернулись! Время превратить твою крошечную квартиру в коливинг для 8 человек!",
          author: "- Оппортунистичный Миллениал-Арендодатель",
          tip: "Инвестиционная недвижимость рядом с университетами обычно имеет высокий спрос на аренду."
        },
        october: {
          quote: "👻 Хэллоуин: единственное время, когда цены на недвижимость пугают больше, чем украшения!",
          author: "- Риелтор в Костюме Банкира",
          tip: "Осень - хорошее время для переговоров, продавцы могут быть мотивированы перед зимой."
        },
        november: {
          quote: "🏒 Покупай, когда Canadiens проигрывают (сейчас), продавай, когда они выиграют (никогда)!",
          author: "- Фанат Habs с Подводной Ипотекой",
          tip: "Рассмотрите зимнюю инспекцию для выявления проблем с отоплением и изоляцией."
        },
        december: {
          quote: "🥯 Монреаль: где бублики лучше нью-йоркских, но и аренда тоже!",
          author: "- Fairmount против St-Viateur против Твоего Банковского Счета",
          tip: "Конец года может принести мотивированных продавцов и потенциальные сделки."
        }
      }
    };

    function enhanceProgressIndicator() {
      const stepIndicator = document.querySelector('.step-indicator');
    
      // Add descriptive labels under step numbers
      const stepLabels = {
        en: ['Income', 'Debts', 'Property', 'Details'],
        fr: ['Revenu', 'Dettes', 'Propriété', 'Détails'],
        es: ['Ingresos', 'Deudas', 'Propiedad', 'Detalles'],
        ru: ['Доход', 'Долги', 'Недвижимость', 'Детали']
      };
      
      // Add CSS for step labels
      const styleElement = document.createElement('style');
      styleElement.textContent = `
        .step-label {
          position: absolute;
          top: 55px;
          left: 50%;
          transform: translateX(-50%);
          font-size: 0.8rem;
          white-space: nowrap;
          color: var(--text-color);
          opacity: 0.8;
          font-weight: 500;
          transition: all 0.3s ease;
          margin-top: 5px;
        }
        
        .step.active .step-label {
          color: var(--primary-color);
          opacity: 1;
          font-weight: 600;
        }
        
        .step.completed .step-label {
          color: var(--accent-color);
          opacity: 1;
        }
        
        @media (max-width: 480px) {
          .step-label {
            font-size: 0.7rem;
            top: 40px;
          }
        }
        
        @media (max-width: 360px) {
          .step-label {
            font-size: 0.65rem;
            top: 32px;
          }
        }
      `;
      document.head.appendChild(styleElement);
    
      document.querySelectorAll('.step').forEach((step, index) => {
        const labelDiv = document.createElement('div');
        labelDiv.className = 'step-label';
        labelDiv.textContent = stepLabels[currentLanguage][index];
        step.appendChild(labelDiv);
      });
    
      // Add progress bar animation
      const progressBarDiv = document.createElement('div');
      progressBarDiv.className = 'progress-bar';
      progressBarDiv.innerHTML = '<div class="progress"></div>';
      stepIndicator.appendChild(progressBarDiv);
      
      // Add CSS for progress bar
      const progressStyle = document.createElement('style');
      progressStyle.textContent = `
        .progress-bar {
          position: absolute;
          top: 50%;
          left: 0;
          right: 0;
          height: 2px;
          background-color: var(--border-color);
          z-index: 1;
          transform: translateY(-50%);
        }
        
        .progress {
          height: 100%;
          width: 0%;
          background-color: var(--primary-color);
          transition: width 0.5s ease;
        }
      `;
      document.head.appendChild(progressStyle);
    
      // Update progress function
      window.updateProgress = function(step) {
        const progress = document.querySelector('.progress');
        if (progress) {
          const progressPercentage = ((step - 1) / 3) * 100;
          progress.style.width = `${progressPercentage}%`;
        }
      };
      
      // Update language function for step labels
      const originalUpdateLanguage = updateLanguage;
      updateLanguage = function() {
        originalUpdateLanguage();
        
        // Update step labels when language changes
        const currentLang = currentLanguage || 'en';
        const labels = stepLabels[currentLang] || stepLabels.en;
        
        document.querySelectorAll('.step').forEach((step, index) => {
          const labelDiv = step.querySelector('.step-label');
          if (labelDiv) {
            labelDiv.textContent = labels[index];
          }
        });
      };
    }

    // Update BOC meeting information based on current language
    function updateBOCMeeting() {
      const lang = bocTranslations[currentLanguage] || bocTranslations.en;
      
      // Update BOC meeting texts
      const nextMeetingEl = document.querySelector('.boc-meeting-date');
      if (nextMeetingEl) {
        nextMeetingEl.textContent = `${lang.nextMeeting} April 16, 2025`;
      }

      // Update consensus labels
      const consensusLabels = document.querySelectorAll('.consensus-label');
      consensusLabels.forEach(label => {
        if (label.textContent.includes('Rate Increase')) {
          label.textContent = `${lang.increase}`;
        } else if (label.textContent.includes('Rate Decrease')) {
          label.textContent = `${lang.decrease}`;
        } else if (label.textContent.includes('Rate Hold')) {
          label.textContent = `${lang.hold}`;
        }
      });

      // Update probability text
      const consensusValues = document.querySelectorAll('.consensus-value');
      consensusValues.forEach(value => {
        const probability = value.textContent.split('%')[0];
        value.textContent = `${probability}% ${lang.probability}`;
      });
    }

    // Get seasonal campaign based on current month
    function getSeasonalCampaign(month) {
      const lang = currentLanguage || 'en';
      const campaigns = seasonalCampaigns[lang] || seasonalCampaigns;
      return campaigns[month] || campaigns['january']; // Default to January if month not found
    }

    // Update seasonal campaign display
    function updateSeasonalCampaign() {
      const currentMonth = new Date().toLocaleString('en-US', { month: 'long' }).toLowerCase();
      const campaign = getSeasonalCampaign(currentMonth);
      
      const titleEl = document.getElementById('campaign-title');
      const descEl = document.getElementById('campaign-description');
      
      if (titleEl && descEl && campaign) {
        titleEl.textContent = campaign.quote;
        descEl.textContent = campaign.author;
      }
    }

    // Track progress through form steps
    function updateProgress(step) {
      const progress = document.querySelector('.progress');
      if (progress) {
        const totalSteps = 4;
        const progressPercentage = ((step - 1) / (totalSteps - 1)) * 100;
        progress.style.width = `${progressPercentage}%`;
      }

      // Update aria attributes for accessibility
      document.querySelectorAll('.step').forEach((stepEl, index) => {
        const stepNum = index + 1;
        if (stepNum < step) {
          stepEl.setAttribute('aria-label', `Step ${stepNum} completed`);
        } else if (stepNum === step) {
          stepEl.setAttribute('aria-label', `Step ${stepNum} current`);
        } else {
          stepEl.setAttribute('aria-label', `Step ${stepNum} pending`);
        }
      });
    }

    // Mortgage terms translations
    const mortgageTerms = {
      en: {
        gdsRatio: "Gross Debt Service Ratio - The percentage of your gross monthly income needed to pay housing expenses.",
        tdsRatio: "Total Debt Service Ratio - The percentage of your gross monthly income needed to cover housing expenses and other debt obligations.",
        cmhcInsurance: "CMHC Insurance - Mortgage default insurance required for down payments less than 20% of the purchase price.",
        amortization: "Amortization Period - The total length of time it will take to pay off your entire mortgage.",
        downPayment: "Down Payment - The initial upfront portion of the total purchase price that you pay when buying a home.",
        ltv: "Loan-to-Value Ratio - The mortgage amount divided by the purchase price, expressed as a percentage.",
        preApproval: "Pre-Approval - A preliminary evaluation from a lender that determines how much they would be willing to lend you.",
        mortgageTerm: "Mortgage Term - The length of time your mortgage agreement and interest rate remain in effect."
      },
      fr: {
        gdsRatio: "Ratio du service de la dette brute - Le pourcentage de votre revenu mensuel brut nécessaire pour payer les dépenses de logement.",
        tdsRatio: "Ratio du service de la dette totale - Le pourcentage de votre revenu mensuel brut nécessaire pour couvrir les dépenses de logement et autres dettes.",
        cmhcInsurance: "Assurance SCHL - Assurance prêt hypothécaire requise pour les mises de fonds inférieures à 20% du prix d'achat.",
        amortization: "Période d'amortissement - La durée totale nécessaire pour rembourser entièrement votre hypothèque.",
        downPayment: "Mise de fonds - La portion initiale du prix d'achat total que vous payez lors de l'achat d'une maison.",
        ltv: "Ratio prêt-valeur - Le montant de l'hypothèque divisé par le prix d'achat, exprimé en pourcentage.",
        preApproval: "Préapprobation - Une évaluation préliminaire d'un prêteur qui détermine le montant qu'il serait prêt à vous prêter.",
        mortgageTerm: "Terme hypothécaire - La durée pendant laquelle votre contrat hypothécaire et votre taux d'intérêt restent en vigueur."
      },
      es: {
        gdsRatio: "Ratio de Servicio de Deuda Bruta - El porcentaje de su ingreso mensual bruto necesario para pagar los gastos de vivienda.",
        tdsRatio: "Ratio de Servicio de Deuda Total - El porcentaje de su ingreso mensual bruto necesario para cubrir gastos de vivienda y otras deudas.",
        cmhcInsurance: "Seguro CMHC - Seguro hipotecario requerido para pagos iniciales menores al 20% del precio de compra.",
        amortization: "Período de Amortización - El tiempo total que tomará pagar su hipoteca completa.",
        downPayment: "Pago Inicial - La porción inicial del precio total de compra que paga al comprar una casa.",
        ltv: "Ratio Préstamo-Valor - El monto de la hipoteca dividido por el precio de compra, expresado como porcentaje.",
        preApproval: "Pre-Aprobación - Una evaluación preliminar de un prestamista que determina cuánto estarían dispuestos a prestarle.",
        mortgageTerm: "Plazo Hipotecario - El período durante el cual su acuerdo hipotecario y tasa de interés permanecen vigentes."
      },
      ru: {
        gdsRatio: "Коэффициент обслуживания валового долга - Процент вашего валового месячного дохода, необходимый для оплаты жилищных расходов.",
        tdsRatio: "Коэффициент обслуживания общего долга - Процент вашего валового месячного дохода, необходимый для покрытия жилищных расходов и других долговых обязательств.",
        cmhcInsurance: "Страхование CMHC - Страхование ипотечного кредита, необходимое при первоначальном взносе менее 20% от цены покупки.",
        amortization: "Период амортизации - Общая продолжительность времени, необходимая для полного погашения ипотеки.",
        downPayment: "Первоначальный взнос - Первоначальная часть от общей стоимости покупки, которую вы платите при покупке дома.",
        ltv: "Соотношение кредита к стоимости - Сумма ипотеки, разделенная на цену покупки, выраженная в процентах.",
        preApproval: "Предварительное одобрение - Предварительная оценка кредитора, определяющая сумму, которую они готовы вам одолжить.",
        mortgageTerm: "Срок ипотеки - Период времени, в течение которого действуют ваш ипотечный договор и процентная ставка."
      }
    };
  </script>
</body>
</html>
